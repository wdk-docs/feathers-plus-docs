

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>feathers-hooks-common Usage &mdash; feathers-plus docs v2019.06.26 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="feathers hooks common guide" href="guide.html" />
    <link rel="prev" title="v1" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> feathers-plus docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">v1</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#extend-feathersjs">扩展FeathersJS</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">feathers-hooks-common Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#find-hooks-using-tags">Find Hooks using Tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migrating-from-auk-to-buzzard">Migrating from Auk to Buzzard</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="guide.html">feathers hooks common guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batch-loader/index.html">batch-loader Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batch-loader/guide.html">batch-loader guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batch-loader/common-patterns.html">batch-loader common patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../authentication-management/index.html">authentication-management Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#service-adapters">服务适配器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#framework-integration">框架集成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new/index.html">whats new</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">feathers-plus docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">v1</a> &raquo;</li>
        
      <li>feathers-hooks-common Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/v1/feathers-hooks-common/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="feathers-hooks-common-usage">
<h1>feathers-hooks-common Usage<a class="headerlink" href="#feathers-hooks-common-usage" title="永久链接至标题">¶</a></h1>
<p>Use feathers-hooks-common v4.x.x with FeathersJS Buzzard.</p>
<p>Use feathers-hooks-common v3.10.0 with FeathersJS Auk. v4.x.x. should
also work if you don’t use callbacks in your hooks.</p>
<p>Hooks may be used on the client as well as the server.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">npm</span> <span class="nx">install</span> <span class="o">--</span><span class="nx">save</span> <span class="nx">feathers</span><span class="o">-</span><span class="nx">hooks</span><span class="o">-</span><span class="nx">common</span>

<span class="c1">// project/src/services/posts/posts.hooks.js</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">disableMultiItemChange</span><span class="p">,</span> <span class="nx">fastJoin</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">postResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">post</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="p">(</span><span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">userId</span>
    <span class="p">}</span> <span class="p">}))[</span><span class="mi">0</span><span class="p">],</span>

    <span class="nx">starers</span><span class="o">:</span> <span class="nx">$select</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">post</span><span class="p">.</span><span class="nx">starers</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span> <span class="p">},</span> <span class="nx">$select</span><span class="o">:</span> <span class="nx">$select</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="p">}</span> <span class="p">}),</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="o">:</span> <span class="p">[</span> <span class="nx">disableMultiItemChange</span><span class="p">()</span> <span class="p">],</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="p">[</span> <span class="nx">disableMultiItemChange</span><span class="p">()</span> <span class="p">]</span>
  <span class="p">},</span>

  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">fastJoin</span><span class="p">(</span><span class="nx">postResolvers</span><span class="p">)</span> <span class="p">],</span>
  <span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="find-hooks-using-tags">
<h2>Find Hooks using Tags<a class="headerlink" href="#find-hooks-using-tags" title="永久链接至标题">¶</a></h2>
<p>Each Feathers hook and utility function is listed under all the tags relevant to it.Hooks</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span>actOnDefault( …hooks )
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{...Function}</span></code> Hook functions.</p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hooks</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">...Function</span></code></p></td>
<td></td>
<td><p>The hooks to
run. They
will mutate
<code class="docutils literal notranslate"><span class="pre">context.da</span>
<span class="pre">ta</span></code>
for before
hooks, or
<code class="docutils literal notranslate"><span class="pre">context.re</span>
<span class="pre">sult</span></code>
for after
hooks. This
is the
default
action for
hooks.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">actOnDefault</span><span class="p">,</span> <span class="nx">actOnDispatch</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">find</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">hook1</span><span class="p">(),</span>
      <span class="nx">actOnDispatch</span><span class="p">(</span><span class="nx">hook2</span><span class="p">(),</span> <span class="nx">actOnDefault</span><span class="p">(</span><span class="nx">hook3</span><span class="p">()),</span> <span class="nx">hook4</span><span class="p">()),</span>
      <span class="nx">hook5</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<p>Hooks <code class="docutils literal notranslate"><span class="pre">hook1</span></code>, <code class="docutils literal notranslate"><span class="pre">hook3</span></code> and <code class="docutils literal notranslate"><span class="pre">hook5</span></code> will run “normally”,
mutating <code class="docutils literal notranslate"><span class="pre">content.result</span></code>. Hooks <code class="docutils literal notranslate"><span class="pre">hook2</span></code> and <code class="docutils literal notranslate"><span class="pre">hook4</span></code> will
mutate <code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code>.</p>
</li>
<li><p><strong>Details</strong></p>
<p>A hook can call a series of hooks using <code class="docutils literal notranslate"><span class="pre">actOnDispatch</span></code>. Some of
those hooks may call other hooks with <code class="docutils literal notranslate"><span class="pre">actOnDefault</span></code> or
<code class="docutils literal notranslate"><span class="pre">actOnDispatch</span></code>. This can “turtle down” to further layers.</p>
<p>The main purpose of <code class="docutils literal notranslate"><span class="pre">actOnDefault</span></code> is to “undo” <code class="docutils literal notranslate"><span class="pre">actOnDispatch</span></code>.</p>
</li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span>actOnDispatch( …hooks )
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{...Function}</span></code> Hook functions.</p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 17%" />
<col style="width: 8%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hooks</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">...Function</span></code></p></td>
<td></td>
<td><p>The hooks to run. They will mutate <code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code>.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">actOnDefault</span><span class="p">,</span> <span class="nx">actOnDispatch</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">find</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">hook1</span><span class="p">(),</span>
      <span class="nx">actOnDispatch</span><span class="p">(</span><span class="nx">hook2</span><span class="p">(),</span> <span class="nx">actOnDefault</span><span class="p">(</span><span class="nx">hook3</span><span class="p">()),</span> <span class="nx">hook4</span><span class="p">()),</span>
      <span class="nx">hook5</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<p>Hooks <code class="docutils literal notranslate"><span class="pre">hook1</span></code>, <code class="docutils literal notranslate"><span class="pre">hook3</span></code> and <code class="docutils literal notranslate"><span class="pre">hook5</span></code> will run “normally”,
mutating <code class="docutils literal notranslate"><span class="pre">content.result</span></code>. Hooks <code class="docutils literal notranslate"><span class="pre">hook2</span></code> and <code class="docutils literal notranslate"><span class="pre">hook4</span></code> will
mutate <code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code>.</p>
</li>
<li><p><strong>Details</strong></p>
<p>A hook can call a series of hooks using <code class="docutils literal notranslate"><span class="pre">actOnDispatch</span></code>. Some of
those hooks may call other hooks with <code class="docutils literal notranslate"><span class="pre">actOnDefault</span></code> or
<code class="docutils literal notranslate"><span class="pre">actOnDispatch</span></code>. This can “turtle down” to further layers.
context.dispatch is a writeable, optional property and contains a
“safe” version of the data that should be sent to any client. If
context.dispatch has not been set context.result will be sent to the
client instead.Note: context.dispatch only affects the data sent
through a Feathers Transport like REST or Socet.io. An internal
method call will still get the data set in context.result.</p>
</li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">alterItems</span><span class="p">(</span> <span class="nx">func</span> <span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">func</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 13%" />
<col style="width: 33%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">func</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(item,</span></code> <code class="docutils literal notranslate"><span class="pre">context)</span> <span class="pre">=</span> <span class="pre">&gt;</span></code> <code class="docutils literal notranslate"><span class="pre">{}</span></code></p></td>
<td><p>Function  modifies <code class="docutils literal notranslate"><span class="pre">item</span></code> in place. See below.</p></td>
</tr>
</tbody>
</table>
<p>“The mutated item. Returning undefined means the item in the parameters was mutated in place.”
result “undefined || item”</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">alterItems</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">alterItems</span><span class="p">(</span><span class="nx">rec</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">delete</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span> <span class="p">})</span> <span class="c1">// Like `discard(&#39;password&#39;)`.</span>
      <span class="nx">alterItems</span><span class="p">(</span><span class="nx">rec</span> <span class="p">=&gt;</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">email</span><span class="p">.</span><span class="nx">lowerCase</span><span class="p">()),</span> <span class="c1">// Like `lowerCase(&#39;email&#39;)`.</span>
    <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<p>Async mutations can be handled with async/await:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">alterItems</span><span class="p">(</span><span class="nx">rec</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">rec</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="p">(</span><span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">await</span> <span class="nx">service</span><span class="p">.</span><span class="nx">get</span><span class="p">(...)</span> <span class="p">)()</span>
<span class="p">})</span>
</pre></div>
</div>
<p>You can also perform async mutations using Promises by returning a
Promise that is resolved once all mutations are complete:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">alterItems</span><span class="p">(</span><span class="nx">rec</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">service</span><span class="p">.</span><span class="nx">get</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">resolve</span><span class="p">();</span>
<span class="p">}});</span>
</pre></div>
</div>
<p>You can also perform async mutations using Promises by returning a
Promise that is resolved once all mutations are complete:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">alterItems</span><span class="p">(</span><span class="nx">async</span> <span class="nx">rec</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">rec</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">service</span><span class="p">.</span><span class="nx">get</span><span class="p">(...);</span>
<span class="p">})</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>The declarative nature of most of the common hooks,
e.g. <code class="docutils literal notranslate"><span class="pre">discard('password')</span></code>, requires you to remember the names of
a fair number of hooks, their parameters, and any possible nuances.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">alterItems</span></code> hook offers an imperative alternative where you
directly alter the items. It allows you to reduce the number of
trivial hooks you have to register, and you are aware of exactly what
your <code class="docutils literal notranslate"><span class="pre">alterItems</span></code> hooks do.</p>
<p><code class="docutils literal notranslate"><span class="pre">func</span></code> is called for each item in <code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or
<code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook). It receives the parameters</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">item</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 46%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">item</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p>The item. The
function
modifies it in
place.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p>The current
context. It
contains any
alterations made
to items so far.</p></td>
</tr>
</tbody>
</table>
</li>
<li><p><strong>Returns</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">func</span></code> may alternatively return a replacement <code class="docutils literal notranslate"><span class="pre">item</span></code> rather than
<code class="docutils literal notranslate"><span class="pre">undefined</span></code>. This is a convenience feature which permits, for
example, use of functions from the <a class="reference external" href="https://lodash.com/">Lodash</a>
library, as such functions tend to return new objects.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote alterItems %}</dt><dd><p>&lt;h3 id=”cache”&gt;</p>
</dd>
</dl>
<p>cache(cacheMap [, keyField] [, options ])</p>
<p>{% hooksApi cache %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object</span> <span class="pre">|</span> <span class="pre">Map}</span> <span class="pre">cacheMap</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">keyField</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">[</span> <span class="pre">options</span> <span class="pre">]</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">clone</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[makeCacheKey]</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cacheMap</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code> <code class="docutils literal notranslate"><span class="pre">Map</span></code></p></td>
<td></td>
<td><p>Instance of
<code class="docutils literal notranslate"><span class="pre">Map</span></code>, or
an object
with a
similar API,
to be used
as the
cache.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">keyField</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">context.se</span>
<span class="pre">rvice.id</span></code>
or
<a href="#id1"><span class="problematic" id="id2">``</span></a>item._id ?</p>
<blockquote>
<div><p>‘_id’ !! ‘i</p>
</div></blockquote>
<p>d’``</p>
</td>
<td><p>The name of
the record
id field.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">option</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>Options.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 31%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a href="#id3"><span class="problematic" id="id4">``</span></a>options
``</p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Descripti
on</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">clone</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Functio</span>
<span class="pre">n</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">item</span> <span class="pre">=&gt;</span> <span class="pre">JSON.par</span>
<span class="pre">se(</span></code>
<code class="docutils literal notranslate"><span class="pre">JSON.stringify(i</span>
<span class="pre">tem)</span> <span class="pre">)</span></code></p></td>
<td><p>Function
to
perform a
deep
clone.
See
below.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">clone</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Functio</span>
<span class="pre">n</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">=&gt;</span> <span class="pre">key</span></code></p></td>
<td><p>Function
to
convert
record
key to
cache
key. Use
this to
convert
MongoDB/M
ongoose
ObjectId/
bson
keys to a
cache key
using
<code class="docutils literal notranslate"><span class="pre">item._i</span>
<span class="pre">d.toStrin</span>
<span class="pre">g()</span></code>.</p></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">CacheMap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/cache&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">cache</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">cacheMap</span> <span class="o">=</span> <span class="nx">CacheMap</span><span class="p">({</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">100</span> <span class="p">});</span> <span class="c1">// Keep the 100 most recently used.</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMap</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMap</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">cache</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">cacheMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMap</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMap</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">CacheMap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/cache&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">cache</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">cacheMap</span> <span class="o">=</span> <span class="nx">CacheMap</span><span class="p">({</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">100</span> <span class="p">});</span>
<span class="kr">const</span> <span class="nx">makeCacheKey</span> <span class="o">=</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="k">instanceof</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span> <span class="o">?</span>
  <span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">:</span> <span class="nx">key</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMap</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">{</span> <span class="nx">makeCacheKey</span> <span class="p">})</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMap</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">{</span> <span class="nx">makeCacheKey</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook <strong>must</strong> be registered in both <code class="docutils literal notranslate"><span class="pre">before</span></code> and
<code class="docutils literal notranslate"><span class="pre">after</span></code>.</p>
</div></blockquote>
<p class="tip"><p>The cache will grow without limit when <code class="docutils literal notranslate"><span class="pre">Map</span></code> is used and the
resulting memory pressure may adversely affect your performance.
<code class="docutils literal notranslate"><span class="pre">Map</span></code> should only be used when you know or can control its size.</p>
</p></li>
<li><p><strong>Details</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook maintain a persistent cache for the service it is
registerd on. A persistent cache stores records so future requests
for those records can be served faster; the records stored in the
cache are duplicates of records stored in the database.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">get</span></code> service method retrieves records from the cache and
updates <code class="docutils literal notranslate"><span class="pre">context.result</span></code> <code class="docutils literal notranslate"><span class="pre">[.data]</span></code>. The other methods remove
their <code class="docutils literal notranslate"><span class="pre">context.data</span></code> entries from the cache in the <code class="docutils literal notranslate"><span class="pre">before</span></code> hook,
and add entries in the <code class="docutils literal notranslate"><span class="pre">after</span></code> hook. All the records returned by a
<code class="docutils literal notranslate"><span class="pre">find</span></code> call are added to the cache.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook may be provided a custom Map instance to use as
its memoization cache. Any object that implements the methods get(),
set(), delete() and clear() can be provided. This allows for custom
Maps which implement various <a class="reference external" href="https://en.wikipedia.org/wiki/Cache_replacement_policies">cache
algorithms</a>
to be provided.</p>
<p>The companion <code class="docutils literal notranslate"><span class="pre">&#64;feathers-plus/cache</span></code> provides a least recently-used
cache which discards the least recently used items first. It is
compatible with <code class="docutils literal notranslate"><span class="pre">cache</span></code> as well as the BatchLoaders used with the
<code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> hook.</p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook can make <a class="reference external" href="#fastjoin">fastJoin</a> hooks run
more efficiently.</p>
</div></blockquote>
<p>MongoDB and Mongoose store record keys as bson objects rather than as
scalars. The safest way to use the cache is in conjunction with the
<code class="docutils literal notranslate"><span class="pre">makeCacheKey</span></code> option.</p>
</li>
<li><p><strong>options.clone</strong></p>
<p>The clone function has a single parameter.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">item</span></code></p></li>
</ul>
<p>It returns</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">clonedItem</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 20%" />
<col style="width: 14%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">item</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The record.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">clonedItem</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>A clone of <code class="docutils literal notranslate"><span class="pre">item</span></code>.</p></td>
</tr>
</tbody>
</table>
<dl class="simple">
<dt>{% hooksApiFootnote cache %}</dt><dd><p>&lt;h3 id=”debug”&gt;</p>
</dd>
</dl>
<p>debug( label [, …fieldNames ] )</p>
<p>{% hooksApi debug %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">label</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array</span> <span class="pre">&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">[</span> <span class="pre">fieldNames</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 14%" />
<col style="width: 8%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">label</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
<td><p>Label to identify the logged information.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fieldNames</span></code></p></td>
<td><p>dot notation</p></td>
<td></td>
<td><p>The field values in <code class="docutils literal notranslate"><span class="pre">context.params</span></code> to display.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">debug</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;step 1&#39;</span><span class="p">),</span> <span class="nx">setNow</span><span class="p">(</span><span class="s1">&#39;updatedAt&#39;</span><span class="p">),</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39; step 2&#39;</span><span class="p">)</span> <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// Result</span>
<span class="o">*</span> <span class="nx">step</span> <span class="mi">1</span>
<span class="nx">type</span><span class="o">:</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">create</span>
<span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Joe Doe&#39;</span> <span class="p">}</span>
<span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">sex</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span> <span class="p">}</span>
<span class="nx">result</span><span class="o">:</span> <span class="p">{</span> <span class="nx">assigned</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="nx">params</span> <span class="nx">props</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;query&#39;</span> <span class="p">]</span>
<span class="o">*</span> <span class="nx">step</span> <span class="mi">2</span>
<span class="nx">type</span><span class="o">:</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">create</span>
<span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Joe Doe&#39;</span><span class="p">,</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="mi">1510518511547</span> <span class="p">}</span>
<span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">sex</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span> <span class="p">}</span>
<span class="nx">result</span><span class="o">:</span> <span class="p">{</span> <span class="nx">assigned</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="nx">params</span> <span class="nx">props</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;query&#39;</span> <span class="p">]</span>
<span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">sex</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span> <span class="p">}</span>
<span class="nx">error</span><span class="o">:</span> <span class="p">...</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">debug</span></code> is great for debugging issues with hooks. Log the hook
context before and after a hook to see what the hook started with,
and what it changed.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote debug %}</dt><dd><p>&lt;h3 id=”depopulate”&gt;</p>
</dd>
</dl>
<p>dePopulate( )</p>
<p>{% hooksApi dePopulate %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">customDepop</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 15%" />
<col style="width: 18%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">customDepop</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">rec</span> <span class="pre">=&gt;</span> <span class="pre">rec</span></code></p></td>
<td><p>Additional modifications for a record.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">dePopulate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">depopulate</span><span class="p">()</span> <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Removes joined records, computed properties, and profile information
created by <code class="docutils literal notranslate"><span class="pre">`populate</span></code> &lt;#populate&gt;`__. Populated and serialized
items may, after dePopulate, be used in service calls.</p>
<p>Removes fields created by resolver functions using <code class="docutils literal notranslate"><span class="pre">fgraphql</span></code>.
Populated items may, after dePopulate, be used in a patch service
call..</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote dePopulate %}</dt><dd><p>&lt;h3 id=”disablemultiitemchange”&gt;</p>
</dd>
</dl>
<p>disableMultiItemChange( )</p>
<p>{% hooksApi disableMultiItemChange %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">disableMultiItemChange</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">patch</span><span class="o">:</span> <span class="nx">disableMultiItemChange</span><span class="p">(),</span>
  <span class="nx">remove</span><span class="o">:</span> <span class="nx">disableMultiItemChange</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>When using the <code class="docutils literal notranslate"><span class="pre">patch</span></code> or <code class="docutils literal notranslate"><span class="pre">remove</span></code> methods, a <code class="docutils literal notranslate"><span class="pre">null</span></code> id could
mutate many, even all the records in the database, so accidentally
using it may cause undesirable results.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote disableMultiItemChange %}</dt><dd><p>&lt;h3 id=”disablemultiitemcreate”&gt;</p>
</dd>
</dl>
<p>disableMultiItemCreate( )</p>
<p>{% hooksApi disableMultiItemCreate %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">disableMultiItemCreate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">disableMultiItemCreate</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">create</span></code> method creates multiple record if passed an array of
items. This hook prevents that, allowing only single records to be
created.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote disableMultiItemCreate %}</dt><dd><p>&lt;h3 id=”disablepagination”&gt;</p>
</dd>
</dl>
<p>disablePagination()</p>
<p>{% hooksApi disablePagination %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">disablePagination</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">disablePagination</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Pagination is disabled if <code class="docutils literal notranslate"><span class="pre">context.query.$limit</span></code> is -1 or ‘-1’. It
works for all types of calls including REST.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote disablePagination %}</dt><dd><p>&lt;h3 id=”disallow”&gt;</p>
</dd>
</dl>
<p>disallow( …transports )</p>
<p>{% hooksApi disallow %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">transports</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id5"><span class="problematic" id="id6">``</span></a>transports
``</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td><p>disallow all
transports</p></td>
<td><p>The
transports
that you
want to
disallow.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 60%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">transports</span></code></p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">socketio</span></code></p></td>
<td><p>disallow calls by Socket.IO transport</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">primus</span></code></p></td>
<td><p>disallow calls by Primus transport</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rest</span></code></p></td>
<td><p>disallow calls by REST transport</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">external</span></code></p></td>
<td><p>disallow calls other than from server</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">server</span></code></p></td>
<td><p>disallow calls from server</p></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">disallow</span><span class="p">,</span> <span class="nx">iff</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// Users can not be created by external access</span>
    <span class="nx">create</span><span class="o">:</span> <span class="nx">disallow</span><span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">),</span>
    <span class="c1">// A user can not be deleted through the REST provider</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="nx">disallow</span><span class="p">(</span><span class="s1">&#39;rest&#39;</span><span class="p">),</span>
    <span class="c1">// disallow calling `update` completely (e.g. to allow only `patch`)</span>
    <span class="nx">update</span><span class="o">:</span> <span class="nx">disallow</span><span class="p">(),</span>
    <span class="c1">// disallow the remove hook if the user is not an admin</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">context</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">isAdmin</span><span class="p">,</span> <span class="nx">disallow</span><span class="p">())</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Prevents access to a service method completely or just for specific
transports. All transports set the <code class="docutils literal notranslate"><span class="pre">context.params.provider</span></code>
property, and <code class="docutils literal notranslate"><span class="pre">disallow</span></code> checks this.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote disallow %}</dt><dd><p>&lt;h3 id=”discard”&gt;</p>
</dd>
</dl>
<p>discard( …fieldNames )</p>
<p>{% hooksApi discard %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The discard hook will remove fields even if the service is being called
from the server. You may want to condition the hook to run only for
external transports,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span> <span class="pre">discard(...))</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<p>{% hooksApiFieldNames discard “One or more fields you want to remove
from the record(s).” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">discard</span> <span class="p">,</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">isProvider</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">),</span> <span class="nx">discard</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;address.city&#39;</span><span class="p">))</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Delete the fields either from <code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or
<code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook). They are not modified if they
are not an object, so a <code class="docutils literal notranslate"><span class="pre">null</span></code> value is supported.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote discard %}</dt><dd><p>&lt;h3 id=”discardquery”&gt;</p>
</dd>
</dl>
<p>discardQuery( …fieldNames )</p>
<p>{% hooksApi discardQuery %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The keep hook will remove any fields not specified even if the service
is being called from the server. You may want to condition the hook to
run only for external transports,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span> <span class="pre">discardQuery(...))</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<p>{% hooksApiFieldNames discardQuery “One or more fields you want to
remove from the query.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">discardQuery</span> <span class="p">,</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">isProvider</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">),</span> <span class="nx">discardQuery</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">))</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Delete the fields from <code class="docutils literal notranslate"><span class="pre">context.params.query</span></code>.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote discardQuery %}</dt><dd><p>&lt;h3 id=”every”&gt;</p>
</dd>
</dl>
<p>every( …predicates )</p>
<p>{% hooksApi every %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;}</span> <span class="pre">predicates</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id7"><span class="problematic" id="id8">``</span></a>predicates
``</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Functions
which take
the current
hook as a
param and
return a
boolean
result.</p></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns every “The logical and of predicates” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">every</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">every</span><span class="p">(</span><span class="nx">hook1</span><span class="p">,</span> <span class="nx">hook2</span><span class="p">,</span> <span class="p">...),</span> <span class="nx">hookA</span><span class="p">,</span> <span class="nx">hookB</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">every</span></code> is a predicate function for use in conditional hooks. The
predicate functions are run in parallel, and <code class="docutils literal notranslate"><span class="pre">true</span></code> is returned if
every predicate returns a truthy value.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote every %}</dt><dd><p>&lt;h3 id=”fastjoin”&gt;</p>
</dd>
</dl>
<p>fastJoin( schema [, query] )</p>
<p>{% hooksApi fastJoin %}</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> is preferred over using <code class="docutils literal notranslate"><span class="pre">populate</span></code>.</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object</span> <span class="pre">|</span> <span class="pre">Function}</span> <span class="pre">resolvers</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">before</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">after</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">joins</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object</span> <span class="pre">|</span> <span class="pre">Function}</span> <span class="pre">[</span> <span class="pre">query</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 41%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">resolvers</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code> or <code class="docutils literal notranslate"><span class="pre">context</span></code> <code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">Object</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">query</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p>run all resolvers with <code class="docutils literal notranslate"><span class="pre">undefined</span></code> params</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">resolvers</span></code></p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">before</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">context</span></code>
<code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">{</span> <span class="pre">}</span></code></p></td>
<td></td>
<td><p>Processing
performed
before the
operations are
started.
Batch-loaders
are usually
created here.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">after</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">context</span></code>
<code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">{</span> <span class="pre">}</span></code></p></td>
<td></td>
<td><p>Processing
performed after
all other
operations are
completed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">joins</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>Resolver
functions
provide a
mapping between
a portion of a
operation and
actual backend
code
responsible for
handling it.</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Read the <a class="reference external" href="guide.html#fastjoin">guide</a> for more information on the
arguments.</p>
</div></blockquote>
<ul>
<li><p><strong>Example using Feathers services</strong></p>
<p class="tip"><p>The services in all these examples are assumed, for simplicity, to
have pagination disabled. You will have to decide when to use
<code class="docutils literal notranslate"><span class="pre">paginate:</span> <span class="pre">false</span></code> in your code.</p>
</p><div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// project/src/services/posts/posts.hooks.js</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">fastJoin</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">postResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">post</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="p">(</span><span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
      <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">userId</span> <span class="p">},</span>
      <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">}))[</span><span class="mi">0</span><span class="p">],</span>

    <span class="nx">starers</span><span class="o">:</span> <span class="nx">$select</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">post</span><span class="p">.</span><span class="nx">starers</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
      <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span> <span class="p">},</span> <span class="nx">$select</span><span class="o">:</span> <span class="nx">$select</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">},</span>
      <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">}),</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">author</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">starers</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]]</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">fastJoin</span><span class="p">(</span><span class="nx">postResolvers</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// Original record</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">]</span> <span class="p">}</span> <span class="p">]</span>

<span class="c1">// Result</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
    <span class="nx">starers</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">}]</span>
</pre></div>
</div>
</li>
<li><p><strong>Example with recursive operations</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// project/src/services/posts/posts.hooks.js</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">fastJoin</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">postResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">resolver</span><span class="o">:</span> <span class="p">(</span><span class="nx">$select</span><span class="p">,</span> <span class="nx">$limit</span><span class="p">,</span> <span class="nx">$sort</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
        <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">$select</span><span class="o">:</span> <span class="nx">$select</span><span class="p">,</span> <span class="nx">$limit</span><span class="o">:</span> <span class="nx">$limit</span> <span class="o">||</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="nx">$sort</span><span class="p">]</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
        <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span>
      <span class="p">}),</span>

      <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">author</span><span class="o">:</span> <span class="nx">$select</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">comment</span> <span class="p">=&gt;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="p">(</span><span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
          <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">$select</span><span class="o">:</span> <span class="nx">$select</span> <span class="p">},</span>
          <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}))[</span><span class="mi">0</span><span class="p">],</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">args</span><span class="o">:</span> <span class="p">[...],</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]]</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">fastJoin</span><span class="p">(</span><span class="nx">postResolvers</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// Original record</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">]</span> <span class="p">}</span> <span class="p">]</span>

<span class="c1">// Result</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">comments</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 11&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 12&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 13&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">}</span> <span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><strong>Example with a simple batch-loader</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// project/src/services/posts/posts.hooks.js</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">fastJoin</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">loaderFactory</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">BatchLoader</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">postResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">loaderFactory</span><span class="p">(</span><span class="nx">users</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span> <span class="p">})(</span><span class="nx">context</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">),</span>

    <span class="nx">starers</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">starers</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">loadMany</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span><span class="p">),</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">fastJoin</span><span class="p">(</span><span class="nx">postResolvers</span><span class="p">)</span> <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// Original record</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">]</span> <span class="p">}</span> <span class="p">]</span>

<span class="c1">// Result</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
    <span class="nx">starers</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">}</span> <span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><strong>Comprehensive example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// project/src/services/posts/posts.hooks.js</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">fastJoin</span><span class="p">,</span> <span class="nx">makeCallingParams</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getResultsByKey</span><span class="p">,</span> <span class="nx">getUniqueKeys</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">BatchLoader</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">commentResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">comment</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">comment</span><span class="p">.</span><span class="nx">userId</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
      <span class="nx">comment</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">postResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{},</span> <span class="nx">comments</span><span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">async</span> <span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">makeCallingParams</span><span class="p">(</span>
          <span class="nx">context</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">},</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">{</span> <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
        <span class="p">));</span>
        <span class="k">return</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">user</span> <span class="p">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="nx">context</span> <span class="p">}</span>
    <span class="p">);</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">postId</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">async</span> <span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">makeCallingParams</span><span class="p">(</span>
          <span class="nx">context</span><span class="p">,</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">},</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">{</span> <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
        <span class="p">));</span>
        <span class="k">return</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">=&gt;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="s1">&#39;[!]&#39;</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="nx">context</span> <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">),</span>

    <span class="nx">starers</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">starIdsRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">loadMany</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span><span class="p">),</span>

    <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">resolver</span><span class="o">:</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">post</span><span class="p">.</span><span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">postId</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span>

      <span class="nx">joins</span><span class="o">:</span> <span class="nx">commentResolvers</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">author</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">starers</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]],</span>
  <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">args</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]]</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">fastJoin</span><span class="p">(</span><span class="nx">postResolvers</span><span class="p">,</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="nx">query</span><span class="p">)</span> <span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// Original record</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">],</span>
    <span class="nx">reputation</span><span class="o">:</span> <span class="p">[</span> <span class="c1">// The `populate` hook cannot handle this structure.</span>
      <span class="p">{</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">points</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">points</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">points</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="p">]},</span>
<span class="p">]</span>

<span class="c1">// Results</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">reputation</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">points</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">points</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">points</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span> <span class="p">],</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
    <span class="nx">comments</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 11&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 12&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 13&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">author</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">],</span>
    <span class="nx">starers</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span> <span class="p">]</span> <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><strong>Example Using a Persistent Cache</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">fastJoin</span><span class="p">,</span> <span class="nx">makeCallingParams</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">CacheMap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/cache&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getResultsByKey</span><span class="p">,</span> <span class="nx">getUniqueKeys</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">BatchLoader</span><span class="p">;</span>

<span class="c1">// Create a cache for a maximum of 100 users</span>
<span class="kr">const</span> <span class="nx">cacheMapUsers</span> <span class="o">=</span> <span class="nx">CacheMap</span><span class="p">({</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">100</span> <span class="p">});</span>

<span class="c1">// Create a batchLoader using the persistent cache</span>
<span class="kr">const</span> <span class="nx">userBatchLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">async</span> <span class="nx">keys</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">makeCallingParams</span><span class="p">(</span>
    <span class="p">{},</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">},</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">{</span> <span class="nx">paginate</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}));</span>
  <span class="k">return</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">user</span> <span class="p">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">);</span>
<span class="p">},</span>
  <span class="p">{</span> <span class="nx">cacheMap</span><span class="o">:</span> <span class="nx">cacheMapUsers</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">postResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">userBatchLoader</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">),</span>

    <span class="nx">starers</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">post</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">starers</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">_loaders</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">loadMany</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span><span class="p">),</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">author</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">starers</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]],</span>
  <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">args</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">author</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]]</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMapUsers</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">cache</span><span class="p">(</span><span class="nx">cacheMapUsers</span><span class="p">),</span>
      <span class="nx">fastJoin</span><span class="p">(</span><span class="nx">postResolvers</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">query</span><span class="p">)</span>
    <span class="p">],</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The number of service calls needed to run the <code class="docutils literal notranslate"><span class="pre">query</span></code> above <strong>the
second time</strong>:</p>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 53%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Using</p></th>
<th class="head"><p>number of service calls</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">populate</span></code></p></td>
<td><p><strong>22</strong></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> alone</p></td>
<td><p><strong>2</strong></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> and <code class="docutils literal notranslate"><span class="pre">cache</span></code></p></td>
<td><p><strong>0</strong></p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook also makes <code class="docutils literal notranslate"><span class="pre">get</span></code> service calls more efficient.</p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook <strong>must</strong> be registered in both <code class="docutils literal notranslate"><span class="pre">before</span></code> and
<code class="docutils literal notranslate"><span class="pre">after</span></code>.</p>
</div></blockquote>
<ul>
<li><p><strong>Details</strong></p>
<p>We often want to combine rows from two or more tables based on a
relationship between them. The <code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> hook will select records
that have matching values in both tables. It can batch service calls
and cache records, thereby needing roughly an order of magnitude
fewer database calls than the <code class="docutils literal notranslate"><span class="pre">populate</span></code> hook, e.g. <em>2</em> calls
instead of <em>20</em>.</p>
<p>Relationships such as <code class="docutils literal notranslate"><span class="pre">1:1</span></code>, <code class="docutils literal notranslate"><span class="pre">1:m</span></code>, <code class="docutils literal notranslate"><span class="pre">n:1</span></code>, and <code class="docutils literal notranslate"><span class="pre">n:m</span></code>
relationships can be handled.</p>
<p><code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> uses a GraphQL-like imperative API, and it is not
restricted to using data from Feathers services. Resources for which
there are no Feathers adapters can <a class="reference external" href="../batch-loader/common-patterns.html#Using-non-Feathers-services">be
used.</a></p>
<p>The companion <code class="docutils literal notranslate"><span class="pre">&#64;feathers-plus/cache</span></code> implements a least
recently-used cache which discards the least recently used items
first. When used in conjunction with the <code class="docutils literal notranslate"><span class="pre">cache</span></code> hook, it can be
used to implement persistent caches for BatchLoaders. BatchLoaders
configured this way would retain their cache between requests,
eliminating the need to <em>prime</em> the cache at the start of each
request.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote fastJoin %}</dt><dd><p>&lt;h3 id=”iff”&gt;</p>
</dd>
</dl>
<p>iff( predicate, …hookFuncsTrue ).else( …hookFuncsFalse )</p>
<p>{% hooksApi iff %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean</span> <span class="pre">|</span> <span class="pre">Promise</span> <span class="pre">|</span> <span class="pre">Function}</span> <span class="pre">predicate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;}</span> <span class="pre">hookFuncsTrue</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;}</span> <span class="pre">hookFuncsFalse</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id9"><span class="problematic" id="id10">``</span></a>predicate`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code>,
<code class="docutils literal notranslate"><span class="pre">Promise</span></code> or
<code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Determine if
<code class="docutils literal notranslate"><span class="pre">hookFuncsT</span>
<span class="pre">rue</span></code>
or
<code class="docutils literal notranslate"><span class="pre">hookFuncsF</span>
<span class="pre">alse</span></code>
should be
run. If a
function,
<code class="docutils literal notranslate"><span class="pre">predicate`</span>
<span class="pre">`</span>
<span class="pre">is</span> <span class="pre">called</span>
<span class="pre">with</span> <span class="pre">the</span>
<span class="pre">``context</span></code>
as its
param. It
returns
either a
boolean or a
Promise that
evaluates to
a boolean.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hookFuncsT</span>
<span class="pre">rue</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span></code>
<code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Sync or
async hook
functions to
run if
<code class="docutils literal notranslate"><span class="pre">true</span></code>.
They may
include
other
conditional
hooks.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hookFuncsF</span>
<span class="pre">alse</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span></code>
<code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Sync or
async hook
functions to
run if
<code class="docutils literal notranslate"><span class="pre">false</span></code>.
They may
include
other
conditional
hooks.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">discard</span><span class="p">,</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">isProvider</span><span class="p">,</span> <span class="nx">populate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">isNotAdmin</span> <span class="o">=</span> <span class="nx">adminRole</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">adminRole</span> <span class="o">||</span> <span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}),</span>
    <span class="nx">populate</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="s1">&#39;authorisedByUserId&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;users&#39;</span> <span class="p">})</span>
  <span class="p">),</span>

  <span class="nx">get</span><span class="o">:</span> <span class="p">[</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">isNotAdmin</span><span class="p">(),</span> <span class="nx">discard</span><span class="p">(</span><span class="s1">&#39;budget&#39;</span><span class="p">))</span> <span class="p">]</span>

  <span class="nx">update</span><span class="o">:</span>
    <span class="nx">iff</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">),</span>
      <span class="nx">hookA</span><span class="p">,</span>
      <span class="nx">iff</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;rest&#39;</span><span class="p">),</span> <span class="nx">hook1</span><span class="p">,</span> <span class="nx">hook2</span><span class="p">,</span> <span class="nx">hook3</span><span class="p">)</span>
      <span class="p">.</span><span class="k">else</span><span class="p">(</span><span class="nx">hook4</span><span class="p">,</span> <span class="nx">hook5</span><span class="p">),</span>
      <span class="nx">hookB</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="k">else</span><span class="p">(</span>
      <span class="nx">iff</span><span class="p">(</span><span class="nx">hook</span> <span class="p">=&gt;</span> <span class="nx">hook</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="nx">hook6</span><span class="p">,</span> <span class="nx">hook7</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Resolve the predicate, then run one set of hooks sequentially.</p>
<p>The predicate and hook functions will not be called with <code class="docutils literal notranslate"><span class="pre">this</span></code> set
to the service, as is normal for hook functions. Use <code class="docutils literal notranslate"><span class="pre">hook.service</span></code>
instead.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote iff %}</dt><dd><p>&lt;h3 id=”iffelse”&gt;</p>
</dd>
</dl>
<p>iffElse( predicate, hookFuncsTrue, hookFuncsFalse )</p>
<p>{% hooksApi iffElse %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">predicate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Functions</span> <span class="pre">&gt;}</span> <span class="pre">hookFuncsTrue</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Functions</span> <span class="pre">&gt;}</span> <span class="pre">hookFuncsFalse</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id11"><span class="problematic" id="id12">``</span></a>predicate`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code>,
<code class="docutils literal notranslate"><span class="pre">Promise</span></code> or
<code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Determine if
<code class="docutils literal notranslate"><span class="pre">hookFuncsT</span>
<span class="pre">rue</span></code>
or
<code class="docutils literal notranslate"><span class="pre">hookFuncsF</span>
<span class="pre">alse</span></code>
should be
run. If a
function,
<code class="docutils literal notranslate"><span class="pre">predicate`</span>
<span class="pre">`</span>
<span class="pre">is</span> <span class="pre">called</span>
<span class="pre">with</span> <span class="pre">the</span>
<span class="pre">``context</span></code>
as its
param. It
returns
either a
boolean or a
Promise that
evaluates to
a boolean.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hookFuncsT</span>
<span class="pre">rue</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span></code>
<code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Sync or
async hook
functions to
run if
<code class="docutils literal notranslate"><span class="pre">true</span></code>.
They may
include
other
conditional
hooks.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hookFuncsF</span>
<span class="pre">alse</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span></code>
<code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Sync or
async hook
functions to
run if
<code class="docutils literal notranslate"><span class="pre">false</span></code>.
They may
include
other
conditional
hooks.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">iffElse</span><span class="p">,</span> <span class="nx">populate</span><span class="p">,</span> <span class="nx">serialize</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">iffElse</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
    <span class="p">[</span><span class="nx">populate</span><span class="p">(</span><span class="nx">poAccting</span><span class="p">),</span> <span class="nx">serialize</span><span class="p">(</span> <span class="p">...</span> <span class="p">)],</span>
    <span class="p">[</span><span class="nx">populate</span><span class="p">(</span><span class="nx">poReceiving</span><span class="p">),</span> <span class="nx">serialize</span><span class="p">(</span> <span class="p">...</span> <span class="p">)]</span>
  <span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Resolve the predicate, then run one set of hooks sequentially.</p>
<p>The predicate and hook functions will not be called with <code class="docutils literal notranslate"><span class="pre">this</span></code> set
to the service, as is normal for hook functions. Use <code class="docutils literal notranslate"><span class="pre">hook.service</span></code>
instead.</p>
</li>
</ul>
<p>isNot( predicate )</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function</span> <span class="pre">|</span> <span class="pre">Boolean}</span> <span class="pre">predicate</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id13"><span class="problematic" id="id14">``</span></a>predicate`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code>
<code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td></td>
<td><p>A sync or
async
function
which take
the current
hook as a
param and
returns a
boolean
result.</p></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns isNot “The not of predicate” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">isNot</span><span class="p">,</span> <span class="nx">isProvider</span><span class="p">,</span> <span class="nx">discard</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">isRequestor</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">...</span> <span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">isNot</span><span class="p">(</span><span class="nx">isRequestor</span><span class="p">()),</span> <span class="nx">discard</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">isNot</span></code> is a predicate function for use in conditional hooks.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote isNot %}</dt><dd><p>&lt;h3 id=”isprovider”&gt;</p>
</dd>
</dl>
<p>isProvider( …transports )</p>
<p>{% hooksApi isProvider %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">transports</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 10%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">transports</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>The transports you want to allow.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 58%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">transports</span></code></p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">socketio</span></code></p></td>
<td><p>Allow calls by Socket.IO transport.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">primus</span></code></p></td>
<td><p>Allow calls by Primus transport.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rest</span></code></p></td>
<td><p>Allow calls by REST transport.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">external</span></code></p></td>
<td><p>Allow calls other than from server.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">server</span></code></p></td>
<td><p>Allow calls from server.</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns isProvider “If the call was made by one of the
transports.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">isProvider</span><span class="p">,</span> <span class="nx">discard</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">),</span> <span class="nx">discard</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">isProvider</span></code> is a predicate function for use in conditional hooks.
Its determines which transport provided the service call by checking
<code class="docutils literal notranslate"><span class="pre">context.params.provider</span></code>.</p>
</li>
</ul>
<p>keep( …fieldNames )</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The keep hook will remove any fields not specified even if the service
is being called from the server. You may want to condition the hook to
run only for external transports,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span> <span class="pre">keep(...))</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<p>{% hooksApiFieldNames keep “The only fields you want to keep in the
record(s).” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">keep</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">keep</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">,</span> <span class="s1">&#39;address.city&#39;</span><span class="p">),</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Update either <code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or
<code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook). Their values are returned if
they are not an object, so a <code class="docutils literal notranslate"><span class="pre">null</span></code> value is supported.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote keep %}</dt><dd><p>&lt;h3 id=”keepinarray”&gt;</p>
</dd>
</dl>
<p>keepInArray( arrayName, fieldNames )</p>
<p>{% hooksApi keepInArray %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The keepInArray hook will remove any fields not specified even if the
service is being called from the server. You may want to condition the
hook to run only for external transports,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span> <span class="pre">keepInArray(...))</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">arrayName</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">fieldNames</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 48%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">arrayName</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fieldNames</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">keepInArray</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">keepInArray</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">,</span> <span class="s1">&#39;address.city&#39;</span><span class="p">]),</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">keepInArray</span><span class="p">(</span><span class="s1">&#39;account.users&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">,</span> <span class="s1">&#39;address.city&#39;</span><span class="p">]),</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Update either <code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or
<code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook). Their values are returned if
they are not an object, so a <code class="docutils literal notranslate"><span class="pre">null</span></code> value is supported.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote keepInArray %}</dt><dd><p>&lt;h3 id=”keepquery”&gt;</p>
</dd>
</dl>
<p>keepQuery( …fieldNames )</p>
<p>{% hooksApi keepQuery %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The keepQuery hook will remove any fields not specified even if the
service is being called from the server. You may want to condition the
hook to run only for external transports,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span> <span class="pre">keepQuery(...))</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<p>{% hooksApiFieldNames keepQuery “The only fields you want to keep in the
query object.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">keepQuery</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">keepQuery</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;address.city&#39;</span><span class="p">),</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Updates <code class="docutils literal notranslate"><span class="pre">context.params.query</span></code>.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote keepQuery %}</dt><dd><p>&lt;h3 id=”keepinarray”&gt;</p>
</dd>
</dl>
<p>keepQueryInArray( arrayName, fieldNames )</p>
<p>{% hooksApi keepQueryInArray %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The keepQueryInArray hook will remove any fields not specified even if
the service is being called from the server. You may want to condition
the hook to run only for external transports,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span> <span class="pre">keepQueryInArray(...))</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<p>{% hooksApiFieldNames keepQueryInArray “The only fields you want to keep
in a nested array inside the query object.” %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">arrayName</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">fieldNames</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 48%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">arrayName</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fieldNames</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">keepQueryInArray</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">keepQueryInArray</span><span class="p">(</span><span class="s1">&#39;$or&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">,</span> <span class="s1">&#39;address.city&#39;</span><span class="p">]),</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Updates <code class="docutils literal notranslate"><span class="pre">context.params.query</span></code>. Their values are returned if they
are not an object, so a <code class="docutils literal notranslate"><span class="pre">null</span></code> value is supported.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote keepQueryInArray %}</dt><dd><p>&lt;h3 id=”lowercase”&gt;</p>
</dd>
</dl>
<p>lowerCase( … fieldNames )</p>
<p>{% hooksApi lowerCase %}</p>
<p>{% hooksApiFieldNames keep “The fields in the record(s) whose values are
converted to lower case.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">lowerCase</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">lowerCase</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;div.dept&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Update either <code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or
<code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook).</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote lowerCase %}</dt><dd><p>&lt;h3 id=”mongokeys”&gt;</p>
</dd>
</dl>
<p>mongoKeys(ObjectID, keys)</p>
<p>{% hooksApi mongoKeys %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">ObjectID</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array</span> <span class="pre">&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">foreignKeyNames</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ObjectID</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">require('m</span>
<span class="pre">ongodb').Obj</span>
<span class="pre">ectID</span></code>
or
equivalent.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">foreignKey</span>
<span class="pre">Names</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array</span> <span class="pre">&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code>
dot notation allowed</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>Field names
of the
foreign
keys.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">ObjectID</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">mongoKeys</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="cm">/* Comment Schema</span>
<span class="cm">{</span>
<span class="cm">  _id,</span>
<span class="cm">  body,</span>
<span class="cm">  authorId,   // User creating this Comment</span>
<span class="cm">  postId,     // Comment is for this Post</span>
<span class="cm">  edit: {</span>
<span class="cm">    reason,</span>
<span class="cm">    editorId, // User last editing Comment</span>
<span class="cm">  )</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kr">const</span> <span class="nx">foreignKeys</span> <span class="o">=</span> <span class="p">[</span>
 <span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="s1">&#39;authorId&#39;</span><span class="p">,</span> <span class="s1">&#39;postId&#39;</span><span class="p">,</span> <span class="s1">&#39;edit.editorId&#39;</span>
<span class="p">];</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">mongoKeys</span><span class="p">(</span><span class="nx">ObjectID</span><span class="p">,</span> <span class="nx">foreignKeys</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// Usage</span>
<span class="nx">comment</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="s1">&#39;111111111111&#39;</span> <span class="p">}</span> <span class="p">})</span>             <span class="c1">// Get all Comments for the Post.</span>
<span class="nx">comment</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">authorId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[...]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">})</span>           <span class="c1">// Get all Comments from these authors.</span>
<span class="nx">comment</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">edit</span><span class="o">:</span> <span class="p">{</span> <span class="nx">editorId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[...]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">})</span> <span class="c1">// Get all comments edited by these editors.</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>In MongoDB, foreign keys must be wrapped in ObjectID when used in a
query,
e.g. <code class="docutils literal notranslate"><span class="pre">comment.find({</span> <span class="pre">query:</span> <span class="pre">{</span> <span class="pre">authorId:</span> <span class="pre">new</span> <span class="pre">ObjectID('111111111111')</span> <span class="pre">}</span> <span class="pre">})</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">mongoKeys</span></code> automates this, given the field names of all the
foreign keys in the schema. This reduces the boilerplate cluuter and
reduces the chance of bugs occurring.</p>
</li>
</ul>
<p>paramsFromClient( …whitelist )</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span> <span class="pre">|</span> <span class="pre">String}</span> <span class="pre">whitelist</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id15"><span class="problematic" id="id16">``</span></a>whitelist`
`</p></td>
<td><p>dot notation</p></td>
<td></td>
<td><p>Names of the
props
permitted to
be in
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams</span></code>.
Other props
are ignored.
This is a
security
feature.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// client</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">paramsForServer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">service</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">paramsForServer</span><span class="p">({</span>
  <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">dept</span><span class="o">:</span> <span class="s1">&#39;a&#39;</span> <span class="p">},</span> <span class="nx">populate</span><span class="o">:</span> <span class="s1">&#39;po-1&#39;</span><span class="p">,</span> <span class="nx">serialize</span><span class="o">:</span> <span class="s1">&#39;po-mgr&#39;</span>
<span class="p">}));</span>

<span class="c1">// server</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">paramsFromClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">paramsFromClient</span><span class="p">(</span><span class="s1">&#39;populate&#39;</span><span class="p">,</span> <span class="s1">&#39;serialize&#39;</span><span class="p">,</span> <span class="s1">&#39;otherProp&#39;</span><span class="p">),</span>
      <span class="nx">myHook</span>
    <span class="p">]</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// myHook&#39;s `context.params` will now be</span>
<span class="c1">// { query: { dept: &#39;a&#39; }, populate: &#39;po-1&#39;, serialize: &#39;po-mgr&#39; } }</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>By default, only the <code class="docutils literal notranslate"><span class="pre">context.params.query</span></code> object is transferred
from a Feathers client to the server, for security among other
reasons. However you can explicitly transfer other <code class="docutils literal notranslate"><span class="pre">context.params</span></code>
props with the client utility function <code class="docutils literal notranslate"><span class="pre">paramsForServer</span></code> in
conjunction with the <code class="docutils literal notranslate"><span class="pre">paramsFromClient</span></code> hook on the server.</p>
<p>This technique also works for service calls made on the server.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote paramsFromClient %}</dt><dd><p>&lt;h3 id=”populate”&gt;</p>
</dd>
</dl>
<p>populate( options )</p>
<p>{% hooksApi populate %}</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> is preferred over using <code class="docutils literal notranslate"><span class="pre">populate</span></code>.</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">options</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object</span> <span class="pre">|</span> <span class="pre">Function}</span> <span class="pre">schema</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">service</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{any}</span> <span class="pre">[</span> <span class="pre">permissions</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Object</span> <span class="pre">&gt;</span> <span class="pre">|</span> <span class="pre">Object}</span> <span class="pre">include</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">service</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">nameAs</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">parentField</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">childField]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">permissions</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">[</span> <span class="pre">query</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">select</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean}</span> <span class="pre">[</span> <span class="pre">asArray</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean</span> <span class="pre">|</span> <span class="pre">Number}</span> <span class="pre">[</span> <span class="pre">paginate</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean}</span> <span class="pre">[</span> <span class="pre">useInnerPopulate</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{undefined}}</span> <span class="pre">[</span> <span class="pre">provider</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Object</span> <span class="pre">&gt;</span> <span class="pre">|</span> <span class="pre">Object}</span> <span class="pre">include</span></code></p>
<ul>
<li><p>…</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">checkPermissions</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean}</span> <span class="pre">[</span> <span class="pre">profile</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 31%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">options</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">schema</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code> <code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(context,</span> <span class="pre">options)</span></code> <code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">{}</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">checkPermissions</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p>no permission check</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">profile</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 35%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">schema</span></code></p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">service</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nameAs</span></code></p></td>
<td><p>dot notation</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">service</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">parentField</span></code></p></td>
<td><p>dot notation</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">childField</span></code></p></td>
<td><p>dot notation if database supports it</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">permissions</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">any</span></code></p></td>
<td><p>no permission check</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">query</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">select</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(context,</span></code> <code class="docutils literal notranslate"><span class="pre">parentItem,</span></code> <code class="docutils literal notranslate"><span class="pre">depth)</span></code> <code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">{}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">asArray</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">paginate</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code> <code class="docutils literal notranslate"><span class="pre">Number</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">useInnerPopulate</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">provider</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">undefined</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">include</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span></code> <code class="docutils literal notranslate"><span class="pre">Object</span> <span class="pre">&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Read the <a class="reference external" href="guide.html#populate">guide</a> for more information on the
arguments.</p>
</div></blockquote>
<ul>
<li><p><strong>Examples</strong></p>
<ul class="simple">
<li><p>1:1 relationship</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// users like { _id: &#39;111&#39;, name: &#39;John&#39;, roleId: &#39;555&#39; }</span>
<span class="c1">// roles like { _id: &#39;555&#39;, permissions: [&#39;foo&#39;, bar&#39;] }</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">populate</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">userRoleSchema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">include</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span>
    <span class="nx">nameAs</span><span class="o">:</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span>
    <span class="nx">parentField</span><span class="o">:</span> <span class="s1">&#39;roleId&#39;</span><span class="p">,</span>
    <span class="nx">childField</span><span class="o">:</span> <span class="s1">&#39;_id&#39;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">populate</span><span class="p">({</span> <span class="nx">schema</span><span class="o">:</span> <span class="nx">userRoleSchema</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// result like</span>
<span class="c1">// { _id: &#39;111&#39;, name: &#39;John&#39;, roleId: &#39;555&#39;,</span>
<span class="c1">//   role: { _id: &#39;555&#39;, permissions: [&#39;foo&#39;, bar&#39;] } }</span>
</pre></div>
</div>
<ul class="simple">
<li><p>1:n relationship</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// users like { _id: &#39;111&#39;, name: &#39;John&#39;, roleIds: [&#39;555&#39;, &#39;666&#39;] }</span>
<span class="c1">// roles like { _id: &#39;555&#39;, permissions: [&#39;foo&#39;, &#39;bar&#39;] }</span>
<span class="kr">const</span> <span class="nx">userRolesSchema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">include</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span>
    <span class="nx">nameAs</span><span class="o">:</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span>
    <span class="nx">parentField</span><span class="o">:</span> <span class="s1">&#39;roleIds&#39;</span><span class="p">,</span>
    <span class="nx">childField</span><span class="o">:</span> <span class="s1">&#39;_id&#39;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">usersService</span><span class="p">.</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">populate</span><span class="p">({</span> <span class="nx">schema</span><span class="o">:</span> <span class="nx">userRolesSchema</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// result like</span>
<span class="c1">// { _id: &#39;111&#39;, name: &#39;John&#39;, roleIds: [&#39;555&#39;, &#39;666&#39;], roles: [</span>
<span class="c1">//   { _id: &#39;555&#39;, permissions: [&#39;foo&#39;, &#39;bar&#39;] }</span>
<span class="c1">//   { _id: &#39;666&#39;, permissions: [&#39;fiz&#39;, &#39;buz&#39;] }</span>
<span class="c1">// ]}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>n:1 relationship</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// posts like { _id: &#39;111&#39;, body: &#39;...&#39; }</span>
<span class="c1">// comments like { _id: &#39;555&#39;, text: &#39;...&#39;, postId: &#39;111&#39; }</span>
<span class="kr">const</span> <span class="nx">postCommentsSchema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">include</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
    <span class="nx">nameAs</span><span class="o">:</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
    <span class="nx">parentField</span><span class="o">:</span> <span class="s1">&#39;_id&#39;</span><span class="p">,</span>
    <span class="nx">childField</span><span class="o">:</span> <span class="s1">&#39;postId&#39;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">postService</span><span class="p">.</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">populate</span><span class="p">({</span> <span class="nx">schema</span><span class="o">:</span> <span class="nx">postCommentsSchema</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// result like</span>
<span class="c1">// { _id: &#39;111&#39;, body: &#39;...&#39; }, comments: [</span>
<span class="c1">//   { _id: &#39;555&#39;, text: &#39;...&#39;, postId: &#39;111&#39; }</span>
<span class="c1">//   { _id: &#39;666&#39;, text: &#39;...&#39;, postId: &#39;111&#39; }</span>
<span class="c1">// ]}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Multiple and recursive includes</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
  <span class="nx">permissions</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
  <span class="nx">include</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span>
      <span class="nx">nameAs</span><span class="o">:</span> <span class="s1">&#39;authorItem&#39;</span><span class="p">,</span>
      <span class="nx">parentField</span><span class="o">:</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span>
      <span class="nx">childField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
      <span class="nx">include</span><span class="o">:</span> <span class="p">[</span> <span class="p">...</span> <span class="p">],</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
      <span class="nx">parentField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
      <span class="nx">childField</span><span class="o">:</span> <span class="s1">&#39;postId&#39;</span><span class="p">,</span>
      <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">$limit</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="nx">$select</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;postId&#39;</span><span class="p">],</span>
        <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span><span class="nx">createdAt</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">select</span><span class="o">:</span> <span class="p">(</span><span class="nx">hook</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="nx">$limit</span><span class="o">:</span> <span class="mi">6</span> <span class="p">}),</span>
      <span class="nx">asArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">provider</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span>
      <span class="nx">permissions</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
      <span class="nx">nameAs</span><span class="o">:</span> <span class="s1">&#39;readers&#39;</span><span class="p">,</span>
      <span class="nx">parentField</span><span class="o">:</span> <span class="s1">&#39;readers&#39;</span><span class="p">,</span>
      <span class="nx">childField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span>
    <span class="p">}</span>
  <span class="p">],</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">after</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">all</span><span class="o">:</span> <span class="nx">populate</span><span class="p">({</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">checkPermissions</span><span class="p">,</span> <span class="nx">profile</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Flexible relationship, similar to the n:1 relationship example
above</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// posts like { _id: &#39;111&#39;, body: &#39;...&#39; }</span>
<span class="c1">// comments like { _id: &#39;555&#39;, text: &#39;...&#39;, postId: &#39;111&#39; }</span>
<span class="kr">const</span> <span class="nx">postCommentsSchema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">include</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">service</span><span class="o">:</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
    <span class="nx">nameAs</span><span class="o">:</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
    <span class="nx">select</span><span class="o">:</span> <span class="p">(</span><span class="nx">hook</span><span class="p">,</span> <span class="nx">parentItem</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="nx">postId</span><span class="o">:</span> <span class="nx">parentItem</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}),</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">postService</span><span class="p">.</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">populate</span><span class="p">({</span> <span class="nx">schema</span><span class="o">:</span> <span class="nx">postCommentsSchema</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// result like</span>
<span class="c1">// { _id: &#39;111&#39;, body: &#39;...&#39; }, comments: [</span>
<span class="c1">//   { _id: &#39;555&#39;, text: &#39;...&#39;, postId: &#39;111&#39; }</span>
<span class="c1">//   { _id: &#39;666&#39;, text: &#39;...&#39;, postId: &#39;111&#39; }</span>
<span class="c1">// ]}</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>We often want to combine rows from two or more tables based on a
relationship between them. The <code class="docutils literal notranslate"><span class="pre">populate</span></code> hook will select records
that have matching values in both tables.</p>
<p><code class="docutils literal notranslate"><span class="pre">populate</span></code> supports 1:1, 1:n and n:1 relationships. It can provide
performance profile information.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote populate %}</dt><dd><p>&lt;h3 id=”preventchanges”&gt;</p>
</dd>
</dl>
<p>preventChanges( ifThrow, …fieldNames )</p>
<p>{% hooksApi preventChanges %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean}</span> <span class="pre">ifThrow</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array</span> <span class="pre">&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">fieldNames</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 13%" />
<col style="width: 8%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ifThrow</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td></td>
<td><p>Deletes any <code class="docutils literal notranslate"><span class="pre">fieldNames</span></code> if <code class="docutils literal notranslate"><span class="pre">false</span></code>; throws if <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fieldNames</span></code></p></td>
<td><p>dot notation</p></td>
<td></td>
<td><p>The fields names which may not be patched.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">preventChanges</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">patch</span><span class="o">:</span> <span class="nx">preventChanges</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;security.badge&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Consider using validateSchema if you would rather specify which
fields are allowed to change.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote preventChanges %}</dt><dd><p>&lt;h3 id=”required”&gt;</p>
</dd>
</dl>
<p>required(…fieldNames)</p>
<p>{% hooksApi required %}</p>
<p>{% hooksApiFieldNames required “These fields must exist and not be
falsey. Numeric 0 is acceptable.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">required</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">all</span><span class="o">:</span> <span class="nx">required</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote required %}</dt><dd><p>&lt;h3 id=”runparallel”&gt;</p>
</dd>
</dl>
<p>runParallel( hookFunc, clone [, depth ] )</p>
<p>{% hooksApi runParallel %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">hookFunc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">clone</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Number}</span> <span class="pre">[</span> <span class="pre">depth</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 32%" />
<col style="width: 32%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Descriptio
n</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id17"><span class="problematic" id="id18">``</span></a>hookFunc
``</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>The hook
function
to run in
parallel
to the
rest of
the
service
call.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">clone</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Function
to deep
clone its
only
parameter.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">depth</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Number</span></code></p></td>
<td><p>6</p></td>
<td><p>Depth to
which
<a href="#id19"><span class="problematic" id="id20">``</span></a>context`
`
is to be
cloned. 0
does not
clone. A
depth of 5
would
clone
<a href="#id21"><span class="problematic" id="id22">``</span></a>context.
result.dat
a.[].item`
<a href="#id23"><span class="problematic" id="id24">`</span></a>.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">runParallel</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;clone&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">sendEmail</span><span class="p">(...)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">runParallel</span><span class="p">(</span><span class="nx">sendEmail</span><span class="p">(...),</span> <span class="nx">clone</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">hookFunc</span></code> is scheduled with a <code class="docutils literal notranslate"><span class="pre">setTimeout</span></code>. The next hook starts
immediately.</p>
<p>The hook was provided by bedeoverend. Thank you.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote runParallel %}</dt><dd><p>&lt;h3 id=”serialize”&gt;</p>
</dd>
</dl>
<p>serialize( schema )</p>
<p>{% hooksApi serialize %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object</span> <span class="pre">|</span> <span class="pre">Function}</span> <span class="pre">schema</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String&gt;</span> <span class="pre">|</span> <span class="pre">String}</span> <span class="pre">only</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String&gt;</span> <span class="pre">|</span> <span class="pre">String}</span> <span class="pre">exclude</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[fieldName]:</span> <span class="pre">{Object}</span> <span class="pre">schema</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">computed</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">[fieldName]:</span> <span class="pre">{Function}</span> <span class="pre">computeFunc</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 27%" />
<col style="width: 29%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">schema</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code> <code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">context</span></code> <code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">schema</span></code></p></td>
<td><p>How to serialize the items.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 31%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a href="#id25"><span class="problematic" id="id26">``</span></a>schema`
`</p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Descripti
on</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">only</span></code></p></td>
<td><p><a href="#id27"><span class="problematic" id="id28">``</span></a>Array&lt;`
`
<a href="#id29"><span class="problematic" id="id30">``</span></a>String&gt;
``
or
<a href="#id31"><span class="problematic" id="id32">``</span></a>String`
`</p></td>
<td></td>
<td><p>The names
of the
fields to
keep in
each
item. The
names for
included
sets of
items
plus
<code class="docutils literal notranslate"><span class="pre">_includ</span>
<span class="pre">e</span></code>
and
<code class="docutils literal notranslate"><span class="pre">_elapse</span>
<span class="pre">d</span></code>
are not
removed
by
<code class="docutils literal notranslate"><span class="pre">only</span></code>.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><a href="#id33"><span class="problematic" id="id34">``</span></a>exclude
``</p></td>
<td><p><a href="#id35"><span class="problematic" id="id36">``</span></a>Array&lt;`
`
<a href="#id37"><span class="problematic" id="id38">``</span></a>String&gt;
``
or
<a href="#id39"><span class="problematic" id="id40">``</span></a>String`
`</p></td>
<td></td>
<td><p>The names
of fields
to drop
in each
item. You
may drop,
at your
own risk,
names of
included
sets of
items,
<code class="docutils literal notranslate"><span class="pre">_includ</span>
<span class="pre">e</span></code>
and
<code class="docutils literal notranslate"><span class="pre">_elapse</span>
<span class="pre">d</span></code>.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">compute</span>
<span class="pre">d</span></code></p></td>
<td><p><a href="#id41"><span class="problematic" id="id42">``</span></a>Object`
`</p></td>
<td></td>
<td><p>The new
names you
want
added and
how to
compute
their
values.</p></td>
<td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 31%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">schema`</span>
<span class="pre">`</span>
<span class="pre">``.comput</span>
<span class="pre">ed</span></code></p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Descripti
on</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">fieldNa</span>
<span class="pre">me</span></code></p></td>
<td><p><a href="#id43"><span class="problematic" id="id44">``</span></a>String`
`</p></td>
<td></td>
<td><p>The name
of the
field to
add to
the
records.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">compute</span>
<span class="pre">Funnc</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Functio</span>
<span class="pre">n</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(record,</span></code>
<code class="docutils literal notranslate"><span class="pre">context)</span></code>
<code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">value</span></code></p></td>
<td><p>Function
to
calculate
the
computed
value.
<code class="docutils literal notranslate"><span class="pre">item</span></code>:
The item
with all
its
initial
values,
plus all
of its
included
items.
The
function
can still
reference
values
which
will be
later
removed
by only
and
exclude.
<code class="docutils literal notranslate"><span class="pre">context</span>
<span class="pre">``:</span>
<span class="pre">The</span>
<span class="pre">context</span>
<span class="pre">passed</span> <span class="pre">to</span>
<span class="pre">``seriali</span>
<span class="pre">ze</span></code>.</p></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<p>The schema reflects the structure of the populated records. The base
records for this example have included <code class="docutils literal notranslate"><span class="pre">post</span></code> records, which
themselves have included <code class="docutils literal notranslate"><span class="pre">authorItem</span></code>, <code class="docutils literal notranslate"><span class="pre">readersInfo</span></code> and
<code class="docutils literal notranslate"><span class="pre">commentsInfo</span></code> records.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">only</span><span class="o">:</span> <span class="s1">&#39;updatedAt&#39;</span><span class="p">,</span>
  <span class="nx">computed</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">commentsCount</span><span class="o">:</span> <span class="p">(</span><span class="nx">recommendation</span><span class="p">,</span> <span class="nx">hook</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">recommendation</span><span class="p">.</span><span class="nx">post</span><span class="p">.</span><span class="nx">commentsInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">post</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;createdAt&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;readers&#39;</span><span class="p">],</span>
    <span class="nx">authorItem</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">],</span>
      <span class="nx">computed</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">isUnder18</span><span class="o">:</span> <span class="p">(</span><span class="nx">authorItem</span><span class="p">,</span> <span class="nx">hook</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">authorItem</span><span class="p">.</span><span class="nx">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
    <span class="nx">readersInfo</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">exclude</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">commentsInfo</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">only</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">],</span>
      <span class="nx">exclude</span><span class="o">:</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">};</span>
<span class="nx">purchaseOrders</span><span class="p">.</span><span class="nx">after</span><span class="p">({</span>
  <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">populate</span><span class="p">(</span> <span class="p">...</span> <span class="p">),</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span> <span class="p">]</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">get</span><span class="o">:</span> <span class="p">[</span> <span class="nx">populate</span><span class="p">(</span> <span class="p">...</span> <span class="p">),</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span> <span class="p">],</span>
  <span class="nx">find</span><span class="o">:</span> <span class="p">[</span> <span class="nx">fastJoin</span><span class="p">(</span> <span class="p">...</span> <span class="p">),</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span> <span class="p">]</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Works with fastJoin and populate.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote serialize %}</dt><dd><p>&lt;h3 id=”setnow”&gt;</p>
</dd>
</dl>
<p>setNow( …fieldNames )</p>
<p>{% hooksApi setNow %}</p>
<p>{% hooksApiFieldNames setNow “The fields that you want to add or set to
the current date-time.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">setNow</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">setNow</span><span class="p">(</span><span class="s1">&#39;createdAt&#39;</span><span class="p">,</span> <span class="s1">&#39;updatedAt&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Update either <code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or
<code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook).</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote setNow %}</dt><dd><p>&lt;h3 id=”setslug”&gt;</p>
</dd>
</dl>
<p>setSlug( slug [, fieldName] )</p>
<p>{% hooksApi setSlug %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">slug</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">fieldName</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">slug</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
<td><p>The slug as
it appears
in the
route,
e.g. <code class="docutils literal notranslate"><span class="pre">sto</span>
<span class="pre">reId</span></code>
for<code class="docutils literal notranslate"><span class="pre">/stor</span>
<span class="pre">es/:storeId/</span>
<span class="pre">candies</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id45"><span class="problematic" id="id46">``</span></a>fieldName`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">query[slug</span>
<span class="pre">]</span></code></p></td>
<td><p>The field to
contain the
slug value.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">setSlug</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">all</span><span class="o">:</span> <span class="p">[</span> <span class="nx">hooks</span><span class="p">.</span><span class="nx">setSlug</span><span class="p">(</span><span class="s1">&#39;storeId&#39;</span><span class="p">)</span> <span class="p">]</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// `context.params.query` will always be normalized,</span>
<span class="c1">// e.g. `{ size: &#39;large&#39;, storeId: &#39;123&#39; }`</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>A service may have a slug in its URL, e.g. <code class="docutils literal notranslate"><span class="pre">storeId</span></code> in
<code class="docutils literal notranslate"><span class="pre">app.use(</span></code> <code class="docutils literal notranslate"><span class="pre">'/stores/:storeId/candies',</span></code> <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Service());</span></code>. The
service gets slightly different values depending on the transport
used by the client.</p>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>transport</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">hook.data</span></code>
<code class="docutils literal notranslate"><span class="pre">.storeId</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">hook.params</span></code>
<code class="docutils literal notranslate"><span class="pre">.query</span></code></p></th>
<th class="head"><p>code run on
client</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>socketio</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">undefined</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">size:</span> <span class="pre">'larg</span>
<span class="pre">e',</span></code>
<code class="docutils literal notranslate"><span class="pre">storeId:</span> <span class="pre">'123</span>
<span class="pre">'</span> <span class="pre">}</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">candies.creat</span>
<span class="pre">e({</span> <span class="pre">name:</span> <span class="pre">'Gumm</span>
<span class="pre">i',qty:</span> <span class="pre">100</span> <span class="pre">},`</span>
<span class="pre">`</span>
<span class="pre">``{</span> <span class="pre">query:</span> <span class="pre">{</span> <span class="pre">si</span>
<span class="pre">ze:</span> <span class="pre">'large',</span> <span class="pre">st</span>
<span class="pre">oreId:</span> <span class="pre">'123'</span> <span class="pre">}</span>
<span class="pre">})</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>rest</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">:storeId</span></code></p></td>
<td><p>same as above</p></td>
<td><p>same as above</p></td>
</tr>
<tr class="row-even"><td><p>raw HTTP</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">123</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">size:</span> <span class="pre">'larg</span>
<span class="pre">e'</span> <span class="pre">}</span></code></p></td>
<td><p><a href="#id47"><span class="problematic" id="id48">``</span></a>fetch(‘/store
s/123/candies?s
ize=large’, ..`
`</p></td>
</tr>
</tbody>
</table>
<p>This hook normalizes the difference between the transports.</p>
<dl class="simple">
<dt>{% hooksApiFootnote setSlug %}</dt><dd><p>&lt;h3 id=”sifter”&gt;</p>
</dd>
</dl>
<p>sifter( siftFunc )</p>
<p>{% hooksApi sifter %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">siftFunc</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">siftFunc</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Function
similar to
<a href="#id49"><span class="problematic" id="id50">``</span></a>context =&gt;</p>
<blockquote>
<div><p>sift(mongoQ</p>
</div></blockquote>
<p>ueryObj)``.
Information
about the
mongoQueryOb
j
syntax is
available at
<a href="#id95"><span class="problematic" id="id96">`crcn/sift &lt;
https://gith
ub.com/crcn/
sift.js&gt;`__</span></a>.</p>
</td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">sift</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sift&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">sifter</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">selectCountry</span> <span class="o">=</span> <span class="nx">hook</span> <span class="p">=&gt;</span> <span class="nx">sift</span><span class="p">({</span> <span class="s1">&#39;address.country&#39;</span><span class="o">:</span> <span class="nx">hook</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">country</span> <span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">sifter</span><span class="p">(</span><span class="nx">selectCountry</span><span class="p">),</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">sift</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sift&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">sifter</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">selectCountry</span> <span class="o">=</span> <span class="nx">country</span> <span class="p">=&gt;</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">sift</span><span class="p">({</span> <span class="nx">address</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">country</span><span class="o">:</span> <span class="nx">country</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">sifter</span><span class="p">(</span><span class="nx">selectCountry</span><span class="p">(</span><span class="s1">&#39;Canada&#39;</span><span class="p">)),</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>All official Feathers database adapters support a common way for
querying, sorting, limiting and selecting find method calls. These
are limited to what is commonly supported by all the databases.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sifter</span></code> hook provides an extensive MongoDB-like selection
capabilities, and it may be used to more extensively select records.</p>
<p><code class="docutils literal notranslate"><span class="pre">sifter</span></code> filters the result of a find call. Therefore more records
will be physically read than needed. You can use the Feathers
database adapters query to reduce this number.`</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote sifter %}</dt><dd><p>&lt;h3 id=”skipremaininghooks”&gt;</p>
</dd>
</dl>
<p>skipRemainingHooks( predicate )</p>
<p>{% hooksApi skipRemainingHooks %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The service call will only be skipped if <code class="docutils literal notranslate"><span class="pre">context.result</span></code> has been set
manually.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function</span> <span class="pre">|</span> <span class="pre">Boolean}</span> <span class="pre">predicate</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id51"><span class="problematic" id="id52">``</span></a>predicate`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code>,
<code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><dl class="simple">
<dt><a href="#id53"><span class="problematic" id="id54">``</span></a>content =&gt;</dt><dd><p>content.res</p>
</dd>
</dl>
<p>ult``</p>
</td>
<td><p>A predicate.
If true the
remaining
hooks are
skipped. The
default
checks if
<code class="docutils literal notranslate"><span class="pre">context.re</span>
<span class="pre">sult</span></code>
has been
set.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<p>Skip the remaining hooks if the record was found in the cache.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">skipRemainingHooks</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">get</span><span class="o">:</span> <span class="p">[</span><span class="nx">cache</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">()),</span> <span class="nx">skipRemainingHooks</span><span class="p">()]</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<p>Skip all the <code class="docutils literal notranslate"><span class="pre">after</span></code> hooks if the service call was initiated by the
server.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">all</span><span class="o">:</span> <span class="p">[</span><span class="nx">skipRemainingHooks</span><span class="p">(</span><span class="nx">context</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">provider</span><span class="p">)]</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>The remaining before hooks will be skipped is you use
<code class="docutils literal notranslate"><span class="pre">shipRemainingHooks</span></code> as a before hook. However the after hooks will
still be run.</p>
<p><code class="docutils literal notranslate"><span class="pre">shipRemainingHooks</span></code> skips the remaining hooks in the before, after
or error hooks. It will skip the remaining hooks if used within the
<code class="docutils literal notranslate"><span class="pre">combine</span></code> hook.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote skipRemainingHooks %}</dt><dd><p>&lt;h3 id=”softdelete”&gt;</p>
</dd>
</dl>
<p>softDelete( fieldName )</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>DEPRECATED. Use the <strong>softDelete2</strong> hook instead. It is a noteable
improvement over softDelete.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<p>{% hooksApi softDelete %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>The softDelete2 hooks must be correctly positioned.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">fieldName</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id55"><span class="problematic" id="id56">``</span></a>fieldName`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p><a href="#id57"><span class="problematic" id="id58">``</span></a>’deleted’`
`</p></td>
<td><p>The name of
the field
for the
logically
deleted
flag.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">softDelete</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">dept</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;departments&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">all</span><span class="o">:</span> <span class="nx">softDelete</span><span class="p">(),</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// will throw if item is marked deleted.</span>
<span class="nx">dept</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">then</span><span class="p">(...)</span>

<span class="c1">// methods can be run avoiding softDelete handling</span>
<span class="nx">dept</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$disableSoftDelete</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}}).</span><span class="nx">then</span><span class="p">(...)</span>
</pre></div>
</div>
</li>
<li><p><strong>Detail</strong></p>
<p>Marks items as <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">deleted:</span> <span class="pre">true</span> <span class="pre">}</span></code> instead of physically removing
them. This is useful when you want to discontinue use of, say, a
department, but you have historical information which continues to
refer to the discontinued department.</p>
<p>The hook performs its own preliminary <code class="docutils literal notranslate"><span class="pre">get</span></code> call if the original
service call was not itself a <code class="docutils literal notranslate"><span class="pre">get</span></code>. The calling params for this
prelinary <code class="docutils literal notranslate"><span class="pre">get</span></code> are formed from the original calling context:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">provider</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">provider</span><span class="p">,</span> <span class="c1">// Keep the same transport.</span>
  <span class="nx">_populate</span><span class="o">:</span> <span class="s1">&#39;skip&#39;</span><span class="p">,</span> <span class="c1">// Skip any `fastJoin` or `populate` hooks.</span>
  <span class="nx">authenticated</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">,</span> <span class="c1">// Keep authentication status.</span>
  <span class="nx">user</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span> <span class="c1">// Keep authenticated user information</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="tip"><p>The <code class="docutils literal notranslate"><span class="pre">user</span></code> record is read by
feathers-authentication<code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">a</span></code>get<code class="docutils literal notranslate"><span class="pre">.</span> <span class="pre">The</span></code>softDelete`
hook will be run for this call unless it is conditioned to ignore it.
This situation raises the most issues for this hook.</p>
</p><p class="tip"><p>The hook will not function properly if you remove the <code class="docutils literal notranslate"><span class="pre">deleted</span></code>
flag in your hooks. It has to returned in the record.</p>
</p></li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote softDelete %}</dt><dd><p>&lt;h3 id=”softdelete2”&gt;</p>
</dd>
</dl>
<p>softDelete2( options )</p>
<p>{% hooksApi softDelete2 %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>softDelete2 must be correctly positioned as both a before and an after
hook. Refer to the <strong>Details</strong> section and the <strong>Examples</strong>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">options</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">options</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{}</span></code></p></td>
<td><p>The options
for the
hook. The
allowed
options
differ
depending on
whether the
hook is used
in before or
after.</p></td>
</tr>
</tbody>
</table>
<p>When used as a before hook:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 51%" />
<col style="width: 21%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">options</span></code></p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">deletedAt</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'deletedAt'</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">keepOnCreate</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">skipProbeOnGet</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">allowIgnore</span></code> <code class="docutils literal notranslate"><span class="pre">DeletedAt</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">true</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">probeCall</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p>built-in default</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">patchCall</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p>built-in default</p></td>
</tr>
</tbody>
</table>
<p>When used as an after hook:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 53%" />
<col style="width: 20%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">options</span></code></p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">deletedAt</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'deletedAt'</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">skipProbeOnGet</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">allowIgnore</span></code> <code class="docutils literal notranslate"><span class="pre">DeletedAt</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">true</span></code></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Examples</strong></p></li>
</ul>
<p>Usage without authentication:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// On server</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">softDelete2</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">softDelete2</span><span class="p">()</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">softDelete2</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// will throw if item is marked deleted.</span>
<span class="kr">const</span> <span class="nx">rec</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// methods can be run avoiding softDelete handling</span>
<span class="kr">const</span> <span class="nx">rec</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="nx">$ignoreDeletedAt</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</pre></div>
</div>
<p>Usage with authentication:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// On server</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">authenticate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/authentication&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">;</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">hashPassword</span><span class="p">,</span> <span class="nx">protect</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/authentication-local&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">;</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">restrictToOwner</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-authentication-hooks&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">softDelete2</span><span class="p">,</span> <span class="nx">paramsFromClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>

<span class="nx">users</span><span class="p">.</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span>    <span class="p">[],</span>
    <span class="nx">find</span><span class="o">:</span>   <span class="p">[</span>                 <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">],</span>
    <span class="nx">get</span><span class="o">:</span>    <span class="p">[</span>                 <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">],</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[</span> <span class="nx">hashPassword</span><span class="p">(),</span> <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">],</span>
    <span class="nx">update</span><span class="o">:</span> <span class="p">[</span> <span class="nx">hashPassword</span><span class="p">(),</span> <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">],</span>
    <span class="nx">patch</span><span class="o">:</span>  <span class="p">[</span> <span class="nx">hashPassword</span><span class="p">(),</span> <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">],</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="p">[</span>                 <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">]</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span>    <span class="p">[</span> <span class="nx">protect</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">]</span> <span class="cm">/* Must always be the last 2 hooks */</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">posts</span><span class="p">.</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span>    <span class="p">[</span> <span class="nx">paramsFromClient</span><span class="p">(</span><span class="s1">&#39;$ignoreDeletedAt&#39;</span><span class="p">),</span> <span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">)</span> <span class="p">],</span>
    <span class="nx">get</span><span class="o">:</span>    <span class="p">[</span> <span class="nx">softDelete2</span><span class="p">(),</span> <span class="nx">restrictToOwner</span><span class="p">({</span> <span class="nx">idField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">ownerField</span><span class="o">:</span> <span class="s1">&#39;ownerId&#39;</span> <span class="p">})</span> <span class="p">],</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[</span> <span class="nx">softDelete2</span><span class="p">(),</span> <span class="nx">restrictToOwner</span><span class="p">({</span> <span class="nx">idField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">ownerField</span><span class="o">:</span> <span class="s1">&#39;ownerId&#39;</span> <span class="p">})</span> <span class="p">],</span>
    <span class="nx">update</span><span class="o">:</span> <span class="p">[</span> <span class="nx">softDelete2</span><span class="p">(),</span> <span class="nx">restrictToOwner</span><span class="p">({</span> <span class="nx">idField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">ownerField</span><span class="o">:</span> <span class="s1">&#39;ownerId&#39;</span> <span class="p">})</span> <span class="p">],</span>
    <span class="nx">patch</span><span class="o">:</span>  <span class="p">[</span> <span class="nx">softDelete2</span><span class="p">(),</span> <span class="nx">restrictToOwner</span><span class="p">({</span> <span class="nx">idField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">ownerField</span><span class="o">:</span> <span class="s1">&#39;ownerId&#39;</span> <span class="p">})</span> <span class="p">],</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="p">[</span> <span class="nx">restrictToOwner</span><span class="p">({</span> <span class="nx">idField</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">ownerField</span><span class="o">:</span> <span class="s1">&#39;ownerId&#39;</span> <span class="p">}),</span> <span class="nx">softDelete2</span><span class="p">()</span> <span class="p">]</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">softDelete2</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// On client</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">paramsForServer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common/lib/services/params-for-server&#39;</span><span class="p">);</span>

<span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">({</span>
  <span class="nx">strategy</span><span class="o">:</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span>
  <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;foo@gmail.com&#39;</span><span class="p">,</span>
  <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>

<span class="c1">// will throw if item is marked deleted.</span>
<span class="kr">const</span> <span class="nx">rec1</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// methods can be run avoiding softDelete handling</span>
<span class="kr">const</span> <span class="nx">rec2</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">paramsForServer</span><span class="p">({</span> <span class="nx">$ignoreDeletedAt</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
</pre></div>
</div>
<ul>
<li><p><strong>Detail</strong></p>
<p>softDelete2 makes a probing get call to check if a record is
logically deleted before allowing it to be accessed or mutated. It
also replaces remove calls with ones to patch
<code class="docutils literal notranslate"><span class="pre">deletedAt:</span> <span class="pre">Date.now()</span></code> into the record.</p>
<p>Find calls, plus patch or remove calls with a <code class="docutils literal notranslate"><span class="pre">null</span></code> id, do not
need a probing get. softDelete2 modifies their <code class="docutils literal notranslate"><span class="pre">params.query</span></code> to
ignore logically deleted records.</p>
</li>
<li><p><strong>An issue with hooks</strong></p>
<p>As mentioned, softDelete2 makes get and patch calls. You may want to
use the authentication hook <code class="docutils literal notranslate"><span class="pre">restrictToOwner</span></code>, but that makes its
own version of a probing get call. Other hooks, such as
<code class="docutils literal notranslate"><span class="pre">stashBefore</span></code>, also make get calls.</p>
<p>A problem may arise because all such calls run the hooks associated
with that call. Let’s say, for example, the hooks on your get method
include <code class="docutils literal notranslate"><span class="pre">fastJoin</span></code>. The <code class="docutils literal notranslate"><span class="pre">restrictToOwner</span></code> probing get call will
run the <code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> on its probing get call, degrading performance
significantly. You have to find ways of explicitly disabling hooks
like <code class="docutils literal notranslate"><span class="pre">fastJoin</span></code>.</p>
<p>Even worse, the nested running of such hooks can create
incompatibilities resulting in errors.</p>
</li>
<li><p><strong>How softDelete2 controls hooks</strong></p>
<p>softDelete2 is run for every call on a service, so its careful to not
run unnecessary hooks during its probing get and removal patch calls.
The hooks following the before <code class="docutils literal notranslate"><span class="pre">softDelete2()</span></code> are skipped, as are
those following the after <code class="docutils literal notranslate"><span class="pre">softDelete2()</span></code>. <em>This skipping occurs
only for the probing get and removal patch calls. All hooks are
executed for the original call.</em></p>
<p>In the example below:</p>
<ul class="simple">
<li><p>The hooks21 &amp; hooks41 hooks on get and patch are run during the
probing get and removing patch.</p></li>
<li><p>The hooks22 &amp; hooks42 hooks are not run during those calls.</p></li>
<li><p>So on an update: hooks31 (for update), hooks21 (probing get),
hooks32 (for update) are run.</p></li>
<li><p>So on a remove: hooks51 (for remove), hooks21 (probing get),
hooks41 (removal patch) are run.</p></li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
   <span class="nx">find</span><span class="o">:</span>   <span class="p">[...</span><span class="nx">hooks01</span><span class="p">,</span> <span class="nx">softDelete</span><span class="p">(),</span> <span class="p">...</span><span class="nx">hooks02</span><span class="p">],</span>
   <span class="nx">create</span><span class="o">:</span> <span class="p">[...</span><span class="nx">hooks11</span><span class="p">,</span> <span class="nx">softDelete</span><span class="p">(),</span> <span class="p">...</span><span class="nx">hooks12</span><span class="p">],</span>
   <span class="nx">get</span><span class="o">:</span>    <span class="p">[...</span><span class="nx">hooks21</span><span class="p">,</span> <span class="nx">softDelete</span><span class="p">(),</span> <span class="p">...</span><span class="nx">hooks22</span><span class="p">],</span>
   <span class="nx">update</span><span class="o">:</span> <span class="p">[...</span><span class="nx">hooks31</span><span class="p">,</span> <span class="nx">softDelete</span><span class="p">(),</span> <span class="p">...</span><span class="nx">hooks32</span><span class="p">],</span>
   <span class="nx">patch</span><span class="o">:</span>  <span class="p">[...</span><span class="nx">hooks41</span><span class="p">,</span> <span class="nx">softDelete</span><span class="p">(),</span> <span class="p">...</span><span class="nx">hooks42</span><span class="p">],</span>
   <span class="nx">remove</span><span class="o">:</span> <span class="p">[...</span><span class="nx">hooks51</span><span class="p">,</span> <span class="nx">softDelete</span><span class="p">()]</span> <span class="c1">// softDelete must be the last hook run for remove calls.</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="nx">softDelete2</span><span class="p">(),</span> <span class="c1">// Must be the first hook run for get or patch calls.</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>options.allowIgnoreDeletedAt</strong></p>
<p>softDelete2 will allow access to logically deleted records if the
call’s params includes <code class="docutils literal notranslate"><span class="pre">$ignoreDeletedAt:</span> <span class="pre">true</span></code> while
options.allowIgnoreDeletedAt is <code class="docutils literal notranslate"><span class="pre">true</span></code> (the default). Be careful
setting it to <code class="docutils literal notranslate"><span class="pre">false</span></code> as not even server calls will be able to read
logically deleted records.</p>
<p>You can prevent just client calls from using
<code class="docutils literal notranslate"><span class="pre">$ignoreDeletedAt:</span> <span class="pre">true</span></code> by not specifying <code class="docutils literal notranslate"><span class="pre">$ignoreDeletedAt</span></code> in
the <code class="docutils literal notranslate"><span class="pre">`paramsFromClient</span></code> &lt;#paramsFromClient&gt;`__ hook.</p>
<p>You may need to prevent other hooks from running as well. You can use
code similar to</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">iff</span><span class="p">(</span><span class="nx">context</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">$ignoreDeletedAt</span><span class="p">,</span> <span class="nx">restrictToOwner</span><span class="p">(...))</span>
</pre></div>
</div>
</li>
<li><p><strong>options.probeCall</strong></p>
<p>The default probing get call function is</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">callingParams</span><span class="p">,</span> <span class="nx">callingParamsDefault</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">defaultProbeCall</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">callingParams</span><span class="p">({</span>
    <span class="nx">newProps</span><span class="o">:</span> <span class="p">{</span> <span class="nx">provider</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">},</span> <span class="nx">hooksToDisable</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;softDelete2&#39;</span><span class="p">]</span>
  <span class="p">})(</span><span class="nx">context</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">options</span></code> is the options provided softDelete2. Its resulting
params will be:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">authenticated</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">,</span>
  <span class="nx">user</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span>
  <span class="nx">provider</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
  <span class="nx">$disableSoftDelete2</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>
</pre></div>
</div>
<p>You can change the params produced by the default function by calling
<code class="docutils literal notranslate"><span class="pre">`callingParamsDefaults</span></code> &lt;#callingparamsdefaults&gt;`__. You can
instead provide your own probing call function using
options.probeCall.</p>
</li>
<li><p><strong>options.patchCall</strong></p>
<p>The default function to perform the patch call which marks the record
as deleted is</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">callingParams</span><span class="p">,</span> <span class="nx">callingParamsDefault</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">defaultPatchCall</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">deletedAt</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">deletedAt</span> <span class="o">||</span> <span class="nx">defaultDeletedAt</span><span class="p">;</span>

  <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">callingParams</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span> <span class="p">{</span> <span class="p">[</span><span class="nx">deletedAt</span><span class="p">]</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}),</span>
    <span class="nx">newProps</span><span class="o">:</span> <span class="p">{</span> <span class="nx">provider</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">},</span>
    <span class="nx">hooksToDisable</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;softDelete2&#39;</span><span class="p">]</span>
  <span class="p">})(</span><span class="nx">context</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span> <span class="p">[</span><span class="nx">deletedAt</span><span class="p">]</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="p">},</span> <span class="nx">params</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">options</span></code> is the options provided softDelete2. Its resulting
params will be:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="p">...,</span> <span class="nx">deletedAt</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
  <span class="nx">authenticated</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">,</span>
  <span class="nx">user</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span>
  <span class="nx">provider</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
  <span class="nx">$disableSoftDelete2</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>
</pre></div>
</div>
<p>You can change the params produced by the default function by calling
<code class="docutils literal notranslate"><span class="pre">`callingParamsDefaults</span></code> &lt;#callingparamsdefaults&gt;`__. You can
instead provide your own probing call function using
options.patchCall.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote softDelete2 %}</dt><dd><p>&lt;h3 id=”some”&gt;</p>
</dd>
</dl>
<p>some( …predicates )</p>
<p>{% hooksApi some %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;}</span> <span class="pre">predicates</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id59"><span class="problematic" id="id60">``</span></a>predicates
``</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Functions
which take
the current
hook as a
param and
return a
boolean
result.</p></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns some “The logical or of predicates” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">iff</span><span class="p">,</span> <span class="nx">some</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="nx">iff</span><span class="p">(</span><span class="nx">some</span><span class="p">(</span><span class="nx">hook1</span><span class="p">,</span> <span class="nx">hook2</span><span class="p">,</span> <span class="p">...),</span> <span class="nx">hookA</span><span class="p">,</span> <span class="nx">hookB</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">some</span></code> is a predicate function for use in conditional hooks. The
predicate functions are run in parallel, and <code class="docutils literal notranslate"><span class="pre">true</span></code> is returned if
any predicate returns a truthy value.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote some %}</dt><dd><p>&lt;h3 id=”stashbefore”&gt;</p>
</dd>
</dl>
<p>stashBefore( fieldName )</p>
<p>{% hooksApi stashBefore %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">fieldName</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id61"><span class="problematic" id="id62">``</span></a>fieldName`
`</p></td>
<td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'before'</span></code></p></td>
<td><p>The name of
the
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams</span></code>
property to
contain the
current
record
value.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">patch</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">patch</span><span class="o">:</span> <span class="nx">stashBefore</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>The hook always performs its own preliminary <code class="docutils literal notranslate"><span class="pre">get</span></code> call. If the
original service call is also a <code class="docutils literal notranslate"><span class="pre">get</span></code>, its <code class="docutils literal notranslate"><span class="pre">context.params</span></code> is
used for the preliminary <code class="docutils literal notranslate"><span class="pre">get</span></code>.</p>
<p>For any other method the calling params are formed from the original
calling context:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="nx">provider</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">provider</span><span class="p">,</span>
  <span class="nx">authenticated</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">,</span>
  <span class="nx">user</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span> <span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote stashBefore %}</dt><dd><p>&lt;h3 id=”traverse”&gt;</p>
</dd>
</dl>
<p>traverse( transformer [, getObject] )</p>
<p>{% hooksApi traverse %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">transformer</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">getObject</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">transforme</span>
<span class="pre">r</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Called for
every node
in every
record(s).
May change
the node in
place.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id63"><span class="problematic" id="id64">``</span></a>getObject`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">context.da</span>
<span class="pre">ta</span></code>
or
<a href="#id65"><span class="problematic" id="id66">``</span></a>context.re
sult[.data]`
`</p></td>
<td><p>Function
with
signature
<a href="#id67"><span class="problematic" id="id68">``</span></a>context =&gt;</p>
<blockquote>
<div><p>{}``</p>
</div></blockquote>
<p>which
returns the
object to
traverse.</p>
</td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">traverse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="c1">// Trim strings</span>
<span class="kr">const</span> <span class="nx">trimmer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// REST HTTP request may use the string &#39;null&#39; in its query string.</span>
<span class="c1">// Replace these strings with the value null.</span>
<span class="kr">const</span> <span class="nx">nuller</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">===</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">trimmer</span><span class="p">),</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">nuller</span><span class="p">,</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Traverse and transform objects in place by visiting every node on a
recursive walk. Any object in the hook may be traversed, including
the query object.</p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/substack/js-traverse">substack/js-traverse</a>
documents the extensive methods and context available to the
transformer function.</p>
</div></blockquote>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote traverse %}</dt><dd><p>&lt;h3 id=”unless”&gt;</p>
</dd>
</dl>
<p>unless( predicate, …hookFuncs )</p>
<p>{% hooksApi unless %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Boolean</span> <span class="pre">|</span> <span class="pre">Promise</span> <span class="pre">|</span> <span class="pre">Function}</span> <span class="pre">predicate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;}</span> <span class="pre">hookFuncs</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id69"><span class="problematic" id="id70">``</span></a>predicate`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code>,
<code class="docutils literal notranslate"><span class="pre">Promise</span></code> or
<code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Run
<code class="docutils literal notranslate"><span class="pre">hookFunc</span></code>
if the
<code class="docutils literal notranslate"><span class="pre">predicate`</span>
<span class="pre">`</span>
<span class="pre">is</span> <span class="pre">false.</span> <span class="pre">If</span>
<span class="pre">a</span> <span class="pre">function,</span>
<span class="pre">``predicate`</span>
<span class="pre">`</span>
<span class="pre">is</span> <span class="pre">called</span>
<span class="pre">with</span> <span class="pre">the</span>
<span class="pre">``context</span></code>
as its
param. It
returns
either a
boolean or a
Promise that
evaluates to
a boolean.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id71"><span class="problematic" id="id72">``</span></a>hookFuncs`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span></code>
<code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Sync or
async hook
functions to
run if
<code class="docutils literal notranslate"><span class="pre">true</span></code>.
They may
include
other
conditional
hooks.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">isProvider</span><span class="p">,</span> <span class="nx">unless</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span>
    <span class="nx">unless</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">),</span>
      <span class="nx">hookA</span><span class="p">,</span>
      <span class="nx">unless</span><span class="p">(</span><span class="nx">isProvider</span><span class="p">(</span><span class="s1">&#39;rest&#39;</span><span class="p">),</span> <span class="nx">hook1</span><span class="p">,</span> <span class="nx">hook2</span><span class="p">,</span> <span class="nx">hook3</span><span class="p">),</span>
      <span class="nx">hookB</span>
    <span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Resolve the predicate to a boolean. Run the hooks sequentially if the
result is falsey.</p>
<p>The predicate and hook functions will not be called with <code class="docutils literal notranslate"><span class="pre">this</span></code> set
to the service, as is normal for hook functions. Use <code class="docutils literal notranslate"><span class="pre">hook.service</span></code>
instead.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote unless %}</dt><dd><p>&lt;h3 id=”validate”&gt;</p>
</dd>
</dl>
<p>validate( validator )</p>
<p>{% hooksApi validate %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">validator</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 17%" />
<col style="width: 10%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">validator</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>Validation function. See Details below..</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">validate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">promisify</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>

<span class="c1">// function myCallbackValidator(values, cb) { ... }</span>
<span class="kr">const</span> <span class="nx">myValidator</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nx">myCallbackValidator</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">myValidator</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>The validation function may be sync or return a Promise. Sync
functions return either an error object like
<code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">fieldName1:</span> <span class="pre">'message',</span> <span class="pre">...</span> <span class="pre">}</span></code> or <code class="docutils literal notranslate"><span class="pre">null</span></code>. They may also throw
with <code class="docutils literal notranslate"><span class="pre">throw</span> <span class="pre">new</span> <span class="pre">errors.BadRequest({</span> <span class="pre">errors:</span> <span class="pre">errors</span> <span class="pre">});</span></code>.</p>
<p>Promise functions should throw on an error or reject with
<code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">errors.BadRequest('Error</span> <span class="pre">message',</span> <span class="pre">{</span> <span class="pre">errors:</span> <span class="pre">{</span> <span class="pre">fieldName1:</span> <span class="pre">'message',</span> <span class="pre">...</span> <span class="pre">}</span> <span class="pre">});</span></code>.
Their <code class="docutils literal notranslate"><span class="pre">.then</span></code> returns either sanitized values to replace
<code class="docutils literal notranslate"><span class="pre">context.data</span></code>, or <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
<p>The validator’s parameters are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">formValues</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
</ul>
<p>Sync functions return either an error object like
<code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">fieldName1:</span> <span class="pre">'message',</span> <span class="pre">...</span> <span class="pre">}</span></code> or <code class="docutils literal notranslate"><span class="pre">null</span></code>. <code class="docutils literal notranslate"><span class="pre">Validate</span></code> will
throw on an error object with
<code class="docutils literal notranslate"><span class="pre">throw</span> <span class="pre">new</span> <span class="pre">errors.BadRequest({</span> <span class="pre">errors:</span> <span class="pre">errorObject</span> <span class="pre">});</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{Object</span> <span class="pre">|</span> <span class="pre">null}</span> <span class="pre">errors</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 20%" />
<col style="width: 7%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">formValues</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The data, e.g. <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">name:</span> <span class="pre">'John',</span> <span class="pre">...</span> <span class="pre">}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The hook context.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">errors</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code> <code class="docutils literal notranslate"><span class="pre">null</span></code></p></td>
<td></td>
<td><p>An error object like <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">fieldName1:</span> <span class="pre">'message',</span> <span class="pre">...</span> <span class="pre">}</span></code></p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>If you have a different signature for the validator then pass a
wrapper as the validator
e.g. <code class="docutils literal notranslate"><span class="pre">values</span> <span class="pre">=&gt;</span> <span class="pre">myValidator(...,</span> <span class="pre">values,</span> <span class="pre">...)</span></code>.</p>
<p>Wrap your validator in Node’s <code class="docutils literal notranslate"><span class="pre">util.promisify</span></code> if it uses a
callback.</p>
</div></blockquote>
<dl class="simple">
<dt>{% hooksApiFootnote validate %}</dt><dd><p>&lt;h3 id=”validateschema”&gt;</p>
</dd>
</dl>
<p>validateSchema( schema, ajv [, options] )</p>
<p>{% hooksApi validateSchema %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">schema</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function</span> <span class="pre">|</span> <span class="pre">Object}</span> <span class="pre">ajv</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">options</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">[</span> <span class="pre">addNewError</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">...</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">schema</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The
<a class="reference external" href="https://code.tutsplus.com/tutorials/validating-data-with-json-schema-part-1--cms-25343">JSON-schema
.</a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ajv</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code>
<code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The ajv
validator.
Could be
either the
Ajv
constructor
or an
instance of
it.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">options</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>Options for
<code class="docutils literal notranslate"><span class="pre">validateSc</span>
<span class="pre">hema</span></code>
and <code class="docutils literal notranslate"><span class="pre">ajv</span></code>.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 31%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a href="#id73"><span class="problematic" id="id74">``</span></a>options
``</p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Descripti
on</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">addNewE</span>
<span class="pre">rror</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Functio</span>
<span class="pre">n</span></code></p></td>
<td><p>see below</p></td>
<td><p>Custom
error
message
formatter
.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>other</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">any</span></code></p></td>
<td></td>
<td><p>Any
<code class="docutils literal notranslate"><span class="pre">ajv</span></code>
options.
Only
effective
when the
second
parameter
is the
<code class="docutils literal notranslate"><span class="pre">Ajv</span></code>
construct
or.</p></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">Ajv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ajv&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">createSchema</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* JSON-Schema */</span> <span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">before</span><span class="p">({</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">validateSchema</span><span class="p">(</span><span class="nx">createSchema</span><span class="p">,</span> <span class="nx">Ajv</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">Ajv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ajv&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">ajv</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ajv</span><span class="p">({</span> <span class="nx">allErrors</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">$data</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="nx">ajv</span><span class="p">.</span><span class="nx">addFormat</span><span class="p">(</span><span class="s1">&#39;allNumbers&#39;</span><span class="p">,</span> <span class="s1">&#39;^\d+$&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">createSchema</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* JSON-Schema */</span> <span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">before</span><span class="p">({</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">validateSchema</span><span class="p">(</span><span class="nx">createSchema</span><span class="p">,</span> <span class="nx">ajv</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>There are some good
<a class="reference external" href="https://code.tutsplus.com/tutorials/validating-data-with-json-schema-part-1--cms-25343">tutorials</a>
on using JSON-Schema with
<a class="reference external" href="https://github.com/epoberezkin/ajv">Ajv</a>.</p>
<p>If you need to customize <code class="docutils literal notranslate"><span class="pre">Ajv</span></code> with new keywords, formats or
schemas, then instead of passing the <code class="docutils literal notranslate"><span class="pre">Ajv</span></code> constructor, you may
pass in an instance of <code class="docutils literal notranslate"><span class="pre">Ajv</span></code> as the second parameter. In this case
you need to pass <code class="docutils literal notranslate"><span class="pre">Ajv</span></code> options to the <code class="docutils literal notranslate"><span class="pre">Ajv</span></code> instance when
<code class="docutils literal notranslate"><span class="pre">new</span></code>ing, rather than passing them in the third parameter of
<code class="docutils literal notranslate"><span class="pre">validateSchema</span></code>. See the examples.</p>
</li>
<li><p><strong>options.addNewError</strong></p>
<p>The hook will throw if the data does not match the JSON-Schema.
<code class="docutils literal notranslate"><span class="pre">error.errors</span></code> will, by default, contain an array of error
messages. You may change this with a custom formatting function. Its
a reducing function which works similarly to <code class="docutils literal notranslate"><span class="pre">Array.reduce()</span></code>. Its
parameters are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{any}</span> <span class="pre">currentFormattedMessages</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">ajvErrorObject</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Number}</span> <span class="pre">itemsLen</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Number}</span> <span class="pre">index</span></code></p></li>
</ul>
<p>It returns</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{any}</span> <span class="pre">newFormattedMessages</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">currentFor</span>
<span class="pre">mattedMessag</span>
<span class="pre">es</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">any</span></code></p></td>
<td><p>initially
<code class="docutils literal notranslate"><span class="pre">null</span></code></p></td>
<td><p>Formatted
messages so
far.
Initially
null.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ajvErrorOb</span>
<span class="pre">ject</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p><a class="reference external" href="https://github.com/epoberezkin/ajv#error-objects">ajv error
object</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">itemsLen</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Number</span></code></p></td>
<td></td>
<td><p>How many
data items
there are.
1-based.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">item</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Number</span></code></p></td>
<td></td>
<td><p>Which item
this is.
0-based.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newFormatt</span>
<span class="pre">edMessages</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">any</span></code></p></td>
<td></td>
<td><p>The function
returns the
updated
formatted
messages.</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">error.errors</span></code> will, by default, contain an array of error messages.
By default the message will look like
<code class="docutils literal notranslate"><span class="pre">js</span>&#160;&#160; <span class="pre">[</span> <span class="pre">&quot;'in</span> <span class="pre">row</span> <span class="pre">1</span> <span class="pre">of</span> <span class="pre">3,</span> <span class="pre">first'</span> <span class="pre">should</span> <span class="pre">match</span> <span class="pre">format</span> <span class="pre">\&quot;startWithJo\&quot;&quot;,</span>&#160;&#160;&#160;&#160; <span class="pre">&quot;in</span> <span class="pre">row</span> <span class="pre">1</span> <span class="pre">of</span> <span class="pre">3,</span> <span class="pre">should</span> <span class="pre">have</span> <span class="pre">required</span> <span class="pre">property</span> <span class="pre">'last'&quot;,</span>&#160;&#160;&#160;&#160; <span class="pre">&quot;'in</span> <span class="pre">row</span> <span class="pre">2</span> <span class="pre">of</span> <span class="pre">3,</span> <span class="pre">first'</span> <span class="pre">should</span> <span class="pre">match</span> <span class="pre">format</span> <span class="pre">\&quot;startWithJo\&quot;&quot;,</span>&#160;&#160;&#160;&#160; <span class="pre">&quot;in</span> <span class="pre">row</span> <span class="pre">3</span> <span class="pre">of</span> <span class="pre">3,</span> <span class="pre">should</span> <span class="pre">have</span> <span class="pre">required</span> <span class="pre">property</span> <span class="pre">'last'&quot;</span> <span class="pre">]</span></code></p>
<blockquote>
<div><p>You could, for example, return <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">name1:</span> <span class="pre">message,</span> <span class="pre">name2:</span> <span class="pre">message</span> <span class="pre">}</span></code>
which might be more suitable for a UI.</p>
</div></blockquote>
<ul>
<li><p><strong>Internationalization of Messages</strong></p>
<p>You can consider using
<a class="reference external" href="https://github.com/epoberezkin/ajv-i18n">ajv-i18n</a>, together with
ajv’s <code class="docutils literal notranslate"><span class="pre">messages</span></code> option, to internationalize your error messages.</p>
<p>You can also consider copying <code class="docutils literal notranslate"><span class="pre">addNewErrorDflt</span></code>, the default error
message formatter, modifying it for your needs, and using that as
<code class="docutils literal notranslate"><span class="pre">newFormattedMessages</span></code>.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote validateSchema %}</dt><dd><p>&lt;h3 id=”when”&gt;</p>
</dd>
</dl>
<p>when( predicate, …hookFuncs )</p>
<p>An alias for <a class="reference external" href="#iff">iff</a>.</p>
<p>{% hooksApiFootnote when %}
Utilities
———</p>
<blockquote>
<div><p>&lt;h3 id=”callingparams”&gt;</p>
</div></blockquote>
<p>callingParams(options)(context)</p>
<p>{% hooksApi callingParams %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">options</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 11%" />
<col style="width: 8%" />
<col style="width: 69%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">options</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>How to construct params for service call.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The <code class="docutils literal notranslate"><span class="pre">context</span></code> of the hook which will make the service call.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 31%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a href="#id75"><span class="problematic" id="id76">``</span></a>options
``</p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Descripti
on</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">query</span></code></p></td>
<td><p><a href="#id77"><span class="problematic" id="id78">``</span></a>Object`
`</p></td>
<td></td>
<td><p>The
<code class="docutils literal notranslate"><span class="pre">params.</span>
<span class="pre">query</span></code>
for the
calling
params.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">propNam</span>
<span class="pre">es</span></code></p></td>
<td><p><a href="#id79"><span class="problematic" id="id80">``</span></a>Array&lt;
String &gt;`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[]</span></code></p></td>
<td><p>The names
of the
props in
<code class="docutils literal notranslate"><span class="pre">context</span>
<span class="pre">.params</span></code>
to
include
in the
new
params.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newProp</span>
<span class="pre">s</span></code></p></td>
<td><p><a href="#id81"><span class="problematic" id="id82">``</span></a>Object`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{}</span></code></p></td>
<td><p>Additiona
l
props to
add to
the new
params.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hooksTo</span>
<span class="pre">Disable</span></code></p></td>
<td><p><a href="#id83"><span class="problematic" id="id84">``</span></a>Array&lt;
String &gt;`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[]</span></code></p></td>
<td><p>The names
of hooks
to
disable
during
the
service
call.
<code class="docutils literal notranslate"><span class="pre">populat</span>
<span class="pre">e</span></code>,
<code class="docutils literal notranslate"><span class="pre">fastJoi</span>
<span class="pre">n</span></code>,
<code class="docutils literal notranslate"><span class="pre">softDel</span>
<span class="pre">ete</span></code>
and
<code class="docutils literal notranslate"><span class="pre">stashBe</span>
<span class="pre">fore</span></code>
are
supported
.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ignoreD</span>
<span class="pre">efaults</span></code></p></td>
<td><p><a href="#id85"><span class="problematic" id="id86">``</span></a>Boolean
``</p></td>
<td></td>
<td><p>Ignore
the
defaults
<code class="docutils literal notranslate"><span class="pre">propNam</span>
<span class="pre">es</span></code>
and
<code class="docutils literal notranslate"><span class="pre">newProp</span>
<span class="pre">s</span></code>.</p></td>
<td></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Returns</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">newParams</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 18%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newParams</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p>The params for the service call.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">callingParams</span><span class="p">,</span> <span class="nx">callingParamsDefaults</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="c1">// Authentication props to always copy. Suitable for feathers-authentication-management.</span>
<span class="nx">callingParamsDefaults</span><span class="p">([</span><span class="s1">&#39;provider&#39;</span><span class="p">,</span> <span class="s1">&#39;authenticated&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;isVerified&#39;</span><span class="p">]);</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">myCustomHook</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">service</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">callingParams</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="nx">propNames</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;customProp&#39;</span><span class="p">],</span>
    <span class="nx">newProps</span><span class="o">:</span> <span class="p">{</span> <span class="nx">mongoose</span><span class="o">:</span> <span class="p">...</span> <span class="p">},</span>
    <span class="nx">hooksToDisable</span><span class="o">:</span> <span class="s1">&#39;populate&#39;</span>
  <span class="p">}),</span> <span class="nx">context</span><span class="p">);</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>When calling another service within a hook, <a class="reference external" href="https://auk.docs.feathersjs.com/guides/step-by-step/basic-feathers/writing-hooks.html#calling-a-service">consideration must be
given</a>
to what the <code class="docutils literal notranslate"><span class="pre">params</span></code> should be for the called service. For example,
should the called service see that a client is making the call, or
the server? What authentication and authorization information should
be provided? You can use this convenience function to help create
that <code class="docutils literal notranslate"><span class="pre">params</span></code>.</p>
<p>The properties <code class="docutils literal notranslate"><span class="pre">provider</span></code>, <code class="docutils literal notranslate"><span class="pre">authenticated</span></code> and <code class="docutils literal notranslate"><span class="pre">user</span></code> are the
standard authentication properties used by Feathers. They are copied
automatically.</p>
<p>These defaults and others can be changed app-wide by calling the
<code class="docutils literal notranslate"><span class="pre">callingParamsDefaults</span></code> utility.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote callingParams %}</dt><dd><p>&lt;h3 id=”callingparamsdefaults”&gt;</p>
</dd>
</dl>
<p>callingParamsDefaults(propNames, newProps)</p>
<p>{% hooksApi callingParamsDefaults %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">propNames</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">newProps</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id87"><span class="problematic" id="id88">``</span></a>propNames`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>The names of
the props in
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams</span></code>
to
automaticall
y
include in
the new
params.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">newProps</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>Additional
props to add
to the new
params.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">callingParams</span><span class="p">,</span> <span class="nx">callingParamsDefaults</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="c1">// Authentication props to always copy. Suitable for feathers-authentication-management.</span>
<span class="c1">// Only hooks will be calling `callingParams`. Set a flag so other hooks recognize such a call.</span>
<span class="nx">callingParamsDefaults</span><span class="p">([</span><span class="s1">&#39;provider&#39;</span><span class="p">,</span> <span class="s1">&#39;authenticated&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;isVerified&#39;</span><span class="p">],</span> <span class="p">{</span> <span class="nx">_calledByHook</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">myCustomHook</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">service</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">callingParams</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="nx">propNames</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;customProp&#39;</span><span class="p">],</span>
    <span class="nx">newProps</span><span class="o">:</span> <span class="p">{</span> <span class="nx">mongoose</span><span class="o">:</span> <span class="p">...</span> <span class="p">},</span>
    <span class="nx">hooksToDisable</span><span class="o">:</span> <span class="s1">&#39;populate&#39;</span>
  <span class="p">}),</span> <span class="nx">context</span><span class="p">);</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>When calling another service within a hook, <a class="reference external" href="https://auk.docs.feathersjs.com/guides/step-by-step/basic-feathers/writing-hooks.html#calling-a-service">consideration must be
given</a>
to what the <code class="docutils literal notranslate"><span class="pre">params</span></code> should be for the called service. For example,
should the called service see that a client is making the call, or
the server? What authentication and authorization information should
be provided? You can use this convenience function to help create
that <code class="docutils literal notranslate"><span class="pre">params</span></code>.</p>
<p>The properties <code class="docutils literal notranslate"><span class="pre">provider</span></code>, <code class="docutils literal notranslate"><span class="pre">authenticated</span></code> and <code class="docutils literal notranslate"><span class="pre">user</span></code> are the
standard authentication properties used by Feathers. They are copied
automatically.</p>
<p>These defaults and others can be changed app-wide by calling the
<code class="docutils literal notranslate"><span class="pre">callingParamsDefaults</span></code> utility.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote callingParamsDefaults %}</dt><dd><p>&lt;h3 id=”checkcontext”&gt;</p>
</dd>
</dl>
<p>checkContext( context [, type ] [, methods ] [, label ] )</p>
<p>{% hooksApi checkContext %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">type</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">[</span> <span class="pre">methods</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">[</span> <span class="pre">label</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The hook
context.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">type</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>all types</p></td>
<td><p>The service
type allowed
- before,
after.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">methods</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td><p>all methods</p></td>
<td><p>The service
methods
allowed -
find, get,
update,
patch,
remove.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">label</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'anonymous</span>
<span class="pre">'</span></code></p></td>
<td><p>Name of hook
to use with
<code class="docutils literal notranslate"><span class="pre">throw</span></code>.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">checkContext</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">myHook</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">checkContext</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">]);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[</span> <span class="nx">myHook</span> <span class="p">]</span> <span class="c1">// throws</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// checkContext(hook, &#39;before&#39;, [&#39;update&#39;, &#39;patch&#39;], &#39;hookName&#39;);</span>
<span class="c1">// checkContext(hook, null, [&#39;update&#39;, &#39;patch&#39;]);</span>
<span class="c1">// checkContext(hook, &#39;before&#39;, null, &#39;hookName&#39;);</span>
<span class="c1">// checkContext(hook, &#39;before&#39;);</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>Its important to ensure the hook is being used as intended.
<code class="docutils literal notranslate"><span class="pre">checkContext</span></code> let’s you restrict the hook to a hook type and a set
of service methods.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote checkContext %}</dt><dd><p>&lt;h3 id=”combine”&gt;</p>
</dd>
</dl>
<p>combine( …hookFuncs )</p>
<p>{% hooksApi combine %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Function</span> <span class="pre">&gt;}</span> <span class="pre">hookFuncs</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id89"><span class="problematic" id="id90">``</span></a>hookFuncs`
`</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;Function</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>Hooks, used
the same way
as when you
register
them.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">combine</span><span class="p">,</span> <span class="nx">createdAt</span><span class="p">,</span> <span class="nx">updatedAt</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">myCustomHook</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">newContext</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">combine</span><span class="p">(</span><span class="nx">setNow</span><span class="p">(</span><span class="s1">&#39;createdAt&#39;</span><span class="p">),</span> <span class="nx">setNow</span><span class="p">(</span><span class="s1">&#39;updatedAt&#39;</span><span class="p">)).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">newContext</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">combine</span></code> has the signature of a hook, but is primarily intended to
be used within your custom hooks, not when registering hooks.</p>
</li>
</ul>
<p>The following is a better technique to use when registering hooks.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="p">[</span><span class="nx">createdAt</span><span class="p">(),</span> <span class="nx">updatedAt</span><span class="p">(),</span> <span class="p">...];</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">update</span><span class="o">:</span> <span class="p">[...</span><span class="nx">workflow</span><span class="p">],</span>
  <span class="nx">patch</span><span class="o">:</span> <span class="p">[...</span><span class="nx">workflow</span><span class="p">],</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<dl class="simple">
<dt>{% hooksApiFootnote combine %}</dt><dd><p>&lt;h3 id=”deletebydot”&gt;</p>
</dd>
</dl>
<p>deleteByDot( obj, path )</p>
<p>{% hooksApi deleteByDot %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">obj</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">path</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 13%" />
<col style="width: 9%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">obj</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The object.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">path</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
<td><p>The path to the property, e.g. <code class="docutils literal notranslate"><span class="pre">address.city</span></code>.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">deleteByDot</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">discardPasscode</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">deleteByDot</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;security.passcode&#39;</span><span class="p">);</span>
<span class="p">}</span>

 <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
   <span class="nx">find</span><span class="o">:</span> <span class="nx">discardPasscode</span><span class="p">()</span>
 <span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">phones.home.0.main</span></code> to handle arrays.</p>
<p>If you delete an array element, e.g. <code class="docutils literal notranslate"><span class="pre">phones.home.1</span></code>, that
element will be removed from the array.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote deleteByDot %}</dt><dd><p>&lt;h3 id=”existsbydot”&gt;</p>
</dd>
</dl>
<p>existsByDot( obj, path )</p>
<p>{% hooksApi existsByDot %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">obj</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">path</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 13%" />
<col style="width: 9%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">obj</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The object.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">path</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
<td><p>The path to the property, e.g. <code class="docutils literal notranslate"><span class="pre">address.city</span></code>.</p></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns getItems “If a property exists at path.” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">discard</span><span class="p">,</span> <span class="nx">existsByDot</span><span class="p">,</span> <span class="nx">iff</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">discardBadge</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">iff</span><span class="p">(</span>
    <span class="o">!</span><span class="nx">existsByDot</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;security.passcode&#39;</span><span class="p">),</span>
    <span class="nx">discard</span><span class="p">(</span><span class="s1">&#39;security.badge&#39;</span><span class="p">)</span>
  <span class="p">)(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">find</span><span class="o">:</span> <span class="nx">discardBadge</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<div class="line-block">
<div class="line">You can use <code class="docutils literal notranslate"><span class="pre">phones.home.0.main</span></code> to handle arrays.</div>
<div class="line">Properties with a value of <code class="docutils literal notranslate"><span class="pre">undefined</span></code> are considered to exist.</div>
</div>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote existsByDot %}</dt><dd><p>&lt;h3 id=”getbydot”&gt;</p>
</dd>
</dl>
<p>getByDot( obj, path )</p>
<p>{% hooksApi getByDot %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">obj</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">path</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 13%" />
<col style="width: 9%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">obj</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The object.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">path</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
<td><p>The path to the property, e.g. <code class="docutils literal notranslate"><span class="pre">address.city</span></code>.</p></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns getItems “The property value.” “result” “any” %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">getByDot</span><span class="p">,</span> <span class="nx">setByDot</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">setHomeCity</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">city</span> <span class="o">=</span> <span class="nx">getByDot</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;person.address.city&#39;</span><span class="p">);</span>
  <span class="nx">setByDot</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="s1">&#39;data.person.home.city&#39;</span><span class="p">,</span> <span class="nx">city</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">setHomeCity</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">getByDot</span></code> does not differentiate between non-existent paths and a
value of <code class="docutils literal notranslate"><span class="pre">undefined</span></code>.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote getByDot %}</dt><dd><p>&lt;h3 id=”setbydot”&gt;</p>
</dd>
</dl>
<p>setByDot( obj, path, value )</p>
<p>{% hooksApi setByDot %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">obj</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{String}</span> <span class="pre">path</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{any}</span> <span class="pre">value</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 13%" />
<col style="width: 9%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">obj</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The object.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">path</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td></td>
<td><p>The path to the property, e.g. <code class="docutils literal notranslate"><span class="pre">address.city</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">value</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">any</span></code></p></td>
<td></td>
<td><p>The value to set the property to.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">getByDot</span><span class="p">,</span> <span class="nx">setByDot</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">setHomeCity</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">city</span> <span class="o">=</span> <span class="nx">getByDot</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;person.address.city&#39;</span><span class="p">);</span>
  <span class="nx">setByDot</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="s1">&#39;data.person.home.city&#39;</span><span class="p">,</span> <span class="nx">city</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">setHomeCity</span><span class="p">()</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote setByDot %}</dt><dd><p>&lt;h3 id=”getitems”&gt;</p>
</dd>
</dl>
<p>getItems( context )</p>
<p>{% hooksApi getItems %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 22%" />
<col style="width: 16%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The hook context.</p></td>
</tr>
</tbody>
</table>
<p>{% hooksApiReturns getItems “The records.”, ‘records’, ‘Array&lt; Object &gt;
| Object | undefined’ %}</p>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">getItems</span><span class="p">,</span> <span class="nx">replaceItems</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">insertCode</span> <span class="o">=</span> <span class="nx">code</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">getItems</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">items</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">item</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">replaceItems</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">insertCode</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">getItems</span></code> gets the records from the hook context: <code class="docutils literal notranslate"><span class="pre">context.data</span></code>
(before hook) or <code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after hook).</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote getItems %}</dt><dd><p>&lt;h3 id=”replaceitems”&gt;</p>
</dd>
</dl>
<p>replaceItems( context, records )</p>
<p>{% hooksApi replaceItems %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">Object</span> <span class="pre">&gt;</span> <span class="pre">|</span> <span class="pre">Object}</span> <span class="pre">records</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 46%" />
<col style="width: 11%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The hook context.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">records</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">Object</span> <span class="pre">&gt;</span></code> <code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The new records.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">getItems</span><span class="p">,</span> <span class="nx">replaceItems</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">insertCode</span> <span class="o">=</span> <span class="nx">code</span> <span class="p">=&gt;</span> <span class="nx">context</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">getItems</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">items</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">item</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">replaceItems</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">create</span><span class="o">:</span> <span class="nx">insertCode</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">replaceItems</span></code> replaces the records in the hook context:
<code class="docutils literal notranslate"><span class="pre">context.data</span></code> (before hook) or <code class="docutils literal notranslate"><span class="pre">context.result[.data]</span></code> (after
hook).</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote replaceItems %}</dt><dd><p>&lt;h3 id=”makecallingparams”&gt;</p>
</dd>
</dl>
<p>makeCallingParams( context, query, include, inject )</p>
<p>{% hooksApi makeCallingParams %}</p>
<blockquote>
<div><p>&lt;p class=”tip”&gt;</p>
</div></blockquote>
<p>You should prefer using the <code class="docutils literal notranslate"><span class="pre">callingParams</span></code> utility to
<code class="docutils literal notranslate"><span class="pre">makeCallingParams</span></code>.</p>
<blockquote>
<div><p>&lt;/p&gt;</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">context</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">[</span> <span class="pre">query</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span> <span class="pre">|</span> <span class="pre">String}</span> <span class="pre">[</span> <span class="pre">include</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">[</span> <span class="pre">inject</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The existing
hook
context.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">query</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams.query</span></code>
for the new
context.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">include</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;</span></code></p></td>
<td></td>
<td><p>The names of
the props in
<code class="docutils literal notranslate"><span class="pre">context</span></code>
to include
in the new
context.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">inject</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>Additional
props to add
to the new
context.</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Returns</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">newContext</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 18%" />
<col style="width: 13%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">newContext</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The new context created.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">makeCallingParams</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">myCustomHook</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">service</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">makeCallingParams</span><span class="p">(</span>
    <span class="nx">context</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">}</span> <span class="p">},</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">_populate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">mongoose</span><span class="o">:</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">));</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>When calling another service within a hook, <a class="reference external" href="https://auk.feathersjs.com/guides/step-by-step/basic-feathers/writing-hooks.html#calling-a-service">consideration must be
given</a>
to what the <code class="docutils literal notranslate"><span class="pre">context.params</span></code> should be for the called service. For
example, should the called service see that a client is making the
call, or the server? What authentication and authorization
information should be provided? You can use this convenience function
to help create that <code class="docutils literal notranslate"><span class="pre">context.params</span></code>.</p>
<p>The value <code class="docutils literal notranslate"><span class="pre">context.params._populate:</span> <span class="pre">'skip'</span></code> is automatically added
to skip any <code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> or <code class="docutils literal notranslate"><span class="pre">populate</span></code> hooks registered on the
called service. Set it to <code class="docutils literal notranslate"><span class="pre">false</span></code>, like in the example above, to
make those hooks run.</p>
</li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote makeCallingParams %}</dt><dd><p>&lt;h3 id=”paramsforserver”&gt;</p>
</dd>
</dl>
<p>paramsForServer( params [, … whitelist] )</p>
<p>{% hooksApi paramsForServer %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">params</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Array&lt;</span> <span class="pre">String</span> <span class="pre">&gt;}</span> <span class="pre">[</span> <span class="pre">whitelist</span> <span class="pre">]</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 36%" />
<col style="width: 21%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">params</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td></td>
<td><p>The
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams</span></code>
to use for
the service
call,
including
any query
object.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id91"><span class="problematic" id="id92">``</span></a>whitelist`
`</p></td>
<td><p>dot notation</p></td>
<td><p>all props in
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams</span></code></p></td>
<td><p>Names of the
props in
<code class="docutils literal notranslate"><span class="pre">context.pa</span>
<span class="pre">rams</span></code>
to transfer
to the
server. This
is a
security
feature. All
props are
transferred
if no
<a href="#id93"><span class="problematic" id="id94">``</span></a>whitelist`
`
is provided.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// client</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">paramsForServer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">service</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">paramsForServer</span><span class="p">({</span>
  <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">dept</span><span class="o">:</span> <span class="s1">&#39;a&#39;</span> <span class="p">},</span> <span class="nx">populate</span><span class="o">:</span> <span class="s1">&#39;po-1&#39;</span><span class="p">,</span> <span class="nx">serialize</span><span class="o">:</span> <span class="s1">&#39;po-mgr&#39;</span>
<span class="p">}));</span>

<span class="c1">// server</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">paramsFromClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">paramsFromClient</span><span class="p">(</span><span class="s1">&#39;populate&#39;</span><span class="p">,</span> <span class="s1">&#39;serialize&#39;</span><span class="p">,</span> <span class="s1">&#39;otherProp&#39;</span><span class="p">),</span>
      <span class="nx">myHook</span>
    <span class="p">]</span>
<span class="p">}</span> <span class="p">};</span>

<span class="c1">// myHook&#39;s `context.params` will now be</span>
<span class="c1">// { query: { dept: &#39;a&#39; }, populate: &#39;po-1&#39;, serialize: &#39;po-mgr&#39; } }</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p>
<p>By default, only the <code class="docutils literal notranslate"><span class="pre">context.params.query</span></code> object is transferred
from a Feathers client to the server, for security among other
reasons. However you can explicitly transfer other <code class="docutils literal notranslate"><span class="pre">context.params</span></code>
props with the client utility function <code class="docutils literal notranslate"><span class="pre">paramsForServer</span></code> in
conjunction with the <code class="docutils literal notranslate"><span class="pre">paramsFromClient</span></code> hook on the server.</p>
<p>This technique also works for service calls made on the server.</p>
<p class="tip"><p>The data is transfered using <code class="docutils literal notranslate"><span class="pre">context.params.query.$client</span></code>. If
that field already exists, it must be an Object.</p>
</p></li>
</ul>
<dl class="simple">
<dt>{% hooksApiFootnote paramsForServer %}</dt><dd><p>&lt;h3 id=”runhook”&gt;</p>
</dd>
</dl>
<p>runHook( [ hookContext ] )( hookFunc )</p>
<p>{% hooksApi runHook %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{Object}</span> <span class="pre">[</span> <span class="pre">hookContext</span> <span class="pre">]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{Function}</span> <span class="pre">hookFunc</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 18%" />
<col style="width: 10%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hookContext</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{}</span></code></p></td>
<td><p>The <code class="docutils literal notranslate"><span class="pre">context</span></code> for <code class="docutils literal notranslate"><span class="pre">hookFunc</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hookFunc</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Function</span></code></p></td>
<td></td>
<td><p>The hook to run.</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">keep</span><span class="p">,</span> <span class="nx">runHook</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(...)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">runHook</span><span class="p">()(</span><span class="nx">keep</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;address.state&#39;</span><span class="p">))</span> <span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">...);</span> <span class="c1">// [{ name: &#39;Marshall&#39;, address: { state: &#39;UT&#39; }}]</span>

<span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(...);</span>
<span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">runHook</span><span class="p">()(</span><span class="nx">data</span><span class="p">)(</span><span class="nx">keep</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;address.state&#39;</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">fastJoin</span><span class="p">,</span> <span class="nx">runHook</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">runHookFinds</span> <span class="o">=</span> <span class="nx">runHook</span><span class="p">({</span> <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;find&#39;</span> <span class="p">});</span>

<span class="kr">const</span> <span class="nx">paymentsRecords</span><span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">105</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">110</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">115</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">105</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">120</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">106</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">125</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
<span class="p">];</span>
<span class="nx">await</span> <span class="nx">payments</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">paymentsRecords</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">patientsRecords</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;David&#39;</span> <span class="p">},</span>
<span class="p">];</span>
<span class="nx">await</span> <span class="nx">patients</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">patientsRecords</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">paymentResolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">joins</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">patient</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">async</span> <span class="nx">payment</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">payment</span><span class="p">.</span><span class="nx">patient</span> <span class="o">=</span> <span class="p">(</span><span class="nx">await</span> <span class="nx">patients</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">id</span><span class="o">:</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">patientId</span>
      <span class="p">}</span> <span class="p">}))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">await</span> <span class="nx">payments</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">runHookFinds</span><span class="p">(</span><span class="nx">fastJoin</span><span class="p">(</span><span class="nx">paymentResolvers</span><span class="p">))</span> <span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>

<span class="c1">// log</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">patient</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">105</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">patient</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">110</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">patient</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">115</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">patient</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">105</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">120</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">patient</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;David&#39;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">106</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">125</span><span class="p">,</span> <span class="nx">patientId</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">patient</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;David&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>** Details**</p>
<p>Hooks are normally registered for a service, e.g. in
<code class="docutils literal notranslate"><span class="pre">project/src/services</span></code> <code class="docutils literal notranslate"><span class="pre">/posts/posts.hooks.js</span></code>. This is nice and
simple when, for example, all the <code class="docutils literal notranslate"><span class="pre">find</span></code> hooks have to run for
every <code class="docutils literal notranslate"><span class="pre">find</span></code> call.</p>
<p>The <a class="reference external" href="#tag-Conditionals">conditional hooks</a> can be used when hooks
have to be conditionally run based on the current environment. For
example, we can discard the <code class="docutils literal notranslate"><span class="pre">password</span></code> field when the call is made
by a client.</p>
<p>However things are not always so straightforward. There can be that
one call for which we want to join specific records. We could add a
conditional hook that runs just for that one call, however we may
soon find ourselves with a second and a third special case.</p>
<p><code class="docutils literal notranslate"><span class="pre">runHook</span></code> is designed for such cases. Instead of having to register
a conditioned hook, it allows us to run the hook in a <code class="docutils literal notranslate"><span class="pre">.then()</span></code>
right after the service call.</p>
</li>
</ul>
<p>{% hooksApiFootnote runHook %}   &lt;h3 id=”???”&gt;</p>
<p>???</p>
<p>{% hooksApi ??? %}</p>
<ul class="simple">
<li><p><strong>Arguments</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">???</span></code></p></li>
</ul>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 11%" />
<col style="width: 19%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">transports</span></code></p></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Example</strong></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="o">???</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-hooks-common&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>

<span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
</li>
<li><p><strong>Details</strong></p></li>
</ul>
<p>{% hooksApiFootnote ??? %}
F.A.Q.
——</p>
<blockquote>
<div><p>&lt;h3 id=”coerce”&gt;</p>
</div></blockquote>
<p>Coerce data types</p>
<p>A common need is converting fields coming in from query params. These
fields are provided as string values by default and you may need them as
numbers, booleans, etc.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">`validateSchema</span></code> &lt;#validateSchema&gt;`__ does a wide selection of
<a class="reference external" href="https://github.com/epoberezkin/ajv/blob/master/COERCION.md">type
coercions</a>,
as well as checking for missing and unexpected fields.
New Features in Buzzard
———————–</p>
<blockquote>
<div><p>Features added since the initial Buzzard release are listed in the
<a class="reference external" href="#whats-new">What’s New section</a>.</p>
</div></blockquote>
<p>These features are new in the Buzzard version.</p>
<ul class="simple">
<li><p>The docs <a class="reference external" href="https://feathers-plus.github.io/v1/feathers-hooks-common">have been
rewritten.</a></p></li>
<li><p>You can now find hooks using <a class="reference external" href="#Find-Hooks-using-Tags">tags.</a> Each
Feathers hook and utility function is listed under all the tags
relevant to it.</p></li>
<li><p>The new <code class="docutils literal notranslate"><span class="pre">fastJoin</span></code> hook is a much faster, more flexible alternative
to <code class="docutils literal notranslate"><span class="pre">populate</span></code>.</p>
<ul>
<li><p>It makes only about 10% of the service calls, i.e. it makes <em>2</em>
calls when <code class="docutils literal notranslate"><span class="pre">populate</span></code> would make <em>20</em>.</p></li>
<li><p>It operates on record formats which <code class="docutils literal notranslate"><span class="pre">populate</span></code> can’t process.</p></li>
<li><p>It provides any Feathers service with GraphQL-light capabilities.
(The new <code class="docutils literal notranslate"><span class="pre">&#64;feathers-plus/graphql</span></code> service adapter provides
similar performance with full GraphQL compatibility.)</p></li>
</ul>
</li>
<li><p>The new <code class="docutils literal notranslate"><span class="pre">runHook</span></code> utility may help simplify your registered hooks.
It let’s you call a hook with
<code class="docutils literal notranslate"><span class="pre">service.get(...).then(runHook()(populate(...)));</span></code>.</p></li>
<li><p>Other new hooks and utility functions.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">alterItems</span></code> - Flexibly mutate data and results. Powerful.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cache</span></code> - Persistent, least-recently-used record cache for
services.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">disablePagination</span></code> - Disables pagination when <code class="docutils literal notranslate"><span class="pre">query.$limit</span></code>
is -1 or ‘-1’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">discardQuery</span></code>, <code class="docutils literal notranslate"><span class="pre">keep</span></code>, <code class="docutils literal notranslate"><span class="pre">keepQuery</span></code> - See Migration below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">makeCallingParams</span></code> utility - Help construct <code class="docutils literal notranslate"><span class="pre">context.params</span></code>
when calling services within hooks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required</span></code> - Check selected fields exist and are not falsey.
Numeric 0 is acceptable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runParallel</span></code> - Run a hook in parallel to the other hooks and
the service call.</p></li>
</ul>
</li>
<li><p>Enhancements to existing hooks.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">debug</span></code> now displays <code class="docutils literal notranslate"><span class="pre">context.params</span></code> property names and
displays the values of selected ones.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">preventChanges</span></code> can now optionally remove unacceptable changes
instead of throwing.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="migrating-from-auk-to-buzzard">
<h2>Migrating from Auk to Buzzard<a class="headerlink" href="#migrating-from-auk-to-buzzard" title="永久链接至标题">¶</a></h2>
<p>These changes may affect your projects when you switch from this repo’s
last Feathers <em>Auk</em> version (v3.10.0) to its first Feathers <em>Buzzard</em>
version (v4.0.0).</p>
<ul class="simple">
<li><p>These hooks are deprecated and will be removed in the next FeathersJS
version <em>Crow</em>.</p>
<ul>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">pluck</span></code> in favor of <code class="docutils literal notranslate"><span class="pre">keep</span></code>,
e.g. <code class="docutils literal notranslate"><span class="pre">iff(isProvider('external'),</span></code> <code class="docutils literal notranslate"><span class="pre">keep(...fieldNames))</span></code>.
This deprecates the last hook with unexpected internal “magic”.
<strong>Be careful!</strong></p></li>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">pluckQuery</span></code> in favor of <code class="docutils literal notranslate"><span class="pre">keepQuery</span></code> for naming
consistency.</p></li>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">removeQuery</span></code> in favor of <code class="docutils literal notranslate"><span class="pre">discardQuery</span></code> for naming
consistency.</p></li>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">client</span></code> in favor of <code class="docutils literal notranslate"><span class="pre">paramsFromClient</span></code> for naming
consistency.</p></li>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">createdAt</span></code> and <code class="docutils literal notranslate"><span class="pre">updatedAt</span></code> in favor of <code class="docutils literal notranslate"><span class="pre">setNow</span></code>.</p></li>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">callbackToPromise</span></code> in favor of Node’s
<code class="docutils literal notranslate"><span class="pre">require('util').promisify</span></code>.</p></li>
<li><p>Deprecated <code class="docutils literal notranslate"><span class="pre">promiseToCallback</span></code> as there’s probably no need for
it anymore.</p></li>
</ul>
</li>
<li><p>Removed hooks previously deprecated in <em>Auk</em>.:</p>
<ul>
<li><p>Removed support for the deprecated legacy syntax in <code class="docutils literal notranslate"><span class="pre">populate</span></code>.</p></li>
<li><p>Removed <code class="docutils literal notranslate"><span class="pre">remove</span></code>.</p></li>
</ul>
</li>
<li><p>The license now includes a clause which prevents the repo from being
published on npm under another name. That is its only purpose; you
can otherwise continue using the repo just as you have in the past.
&lt;h2 id=”whats-new”&gt;</p></li>
</ul>
<p>What’s New</p>
<blockquote>
<div><p>&lt;/h2&gt;</p>
</div></blockquote>
<p>The details are at Changelog.</p>
<div class="section" id="february-2018">
<h3>February 2018<a class="headerlink" href="#february-2018" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>Buzzard version published as <strong>npm</strong> as v4.x.x.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alterItems</span></code> may now optionally return the items rather than
modifying them in place.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">disableMultiItemCreate</span></code> introduced. It prevents a service from
creating multiple records in one service call.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mongoKeys</span></code> introduced for MongoDB services. Its wraps foreign keys
found in <code class="docutils literal notranslate"><span class="pre">query</span></code> in ObjectID.</p></li>
</ul>
</div>
<div class="section" id="march-2018">
<h3>March 2018<a class="headerlink" href="#march-2018" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>Documented how to <a class="reference external" href="guide.html#Making-Hook-Params-Dynamic">make any hook parameter
dynamic</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">skipRemainingHooks</span></code> introduced. It conditionally skips running all
remaining hooks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">actOnDispatch(...hooks)</span></code> and <code class="docutils literal notranslate"><span class="pre">actOnDefault(...hooks)</span></code>. You can
use them to run most common hooks, and any hooks using <code class="docutils literal notranslate"><span class="pre">getItems</span></code>
and <code class="docutils literal notranslate"><span class="pre">replaceItems</span></code> so they mutate <code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code> rather than
<code class="docutils literal notranslate"><span class="pre">context.data</span></code> or <code class="docutils literal notranslate"><span class="pre">context.result</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mongoKeys</span></code> can now be used with any type of service call, not just
<code class="docutils literal notranslate"><span class="pre">find</span></code>.</p></li>
</ul>
</div>
<div class="section" id="june-2018">
<h3>June 2018<a class="headerlink" href="#june-2018" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">discard</span></code> and <code class="docutils literal notranslate"><span class="pre">keep</span></code> support records which are <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p></li>
<li><p>A new, more convenient signature for async functions has been
introduced for <code class="docutils literal notranslate"><span class="pre">alterItems</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">callingParams</span></code> and <code class="docutils literal notranslate"><span class="pre">callingParamsDefaults</span></code> utility functions
added. <code class="docutils literal notranslate"><span class="pre">callingParams</span></code> should now be used rather than
<code class="docutils literal notranslate"><span class="pre">makeCallingParams</span></code>.</p></li>
</ul>
</div>
<div class="section" id="july-2018">
<h3>July 2018<a class="headerlink" href="#july-2018" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">softDelete2</span></code> is a notable improvement over <code class="docutils literal notranslate"><span class="pre">softDelete</span></code>. It
cooperates well with authentication and the <code class="docutils literal notranslate"><span class="pre">restrictToOwner</span></code> hook.
Custom functions are supported for its probing get and removal patch
calls. Hooks defined on these call methods will, by default,not be
executed to eliminate interactions.</p></li>
</ul>
</div>
<div class="section" id="auguset-2018">
<h3>Auguset 2018<a class="headerlink" href="#auguset-2018" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">keepInArray</span></code> For an array of objects, keeps selected field in each
object. Contributed by Dekel Barzilay (dekelev).</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="guide.html" class="btn btn-neutral float-right" title="feathers hooks common guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="v1" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>