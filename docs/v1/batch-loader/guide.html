

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>batch-loader guide &mdash; feathers-plus docs v2019.06.26 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="batch-loader common patterns" href="common-patterns.html" />
    <link rel="prev" title="batch-loader Usage" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> feathers-plus docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Feathers-Plus(Bridging FeathersJS and real world apps)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">v1</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#extend-feathersjs">扩展FeathersJS</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../feathers-hooks-common/index.html">feathers-hooks-common Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../feathers-hooks-common/guide.html">feathers hooks common guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html">batch-loader Usage</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">batch-loader guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#batching">Batching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#caching">Caching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#explore-performance-gains">Explore Performance Gains</a></li>
<li class="toctree-l4"><a class="reference internal" href="#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="common-patterns.html">batch-loader common patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../authentication-management/index.html">authentication-management Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#service-adapters">服务适配器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#framework-integration">框架集成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new/index.html">whats new</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">feathers-plus docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">v1</a> &raquo;</li>
        
      <li>batch-loader guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/v1/batch-loader/guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="batch-loader-guide">
<h1>batch-loader guide<a class="headerlink" href="#batch-loader-guide" title="永久链接至标题">¶</a></h1>
<p>Loading data from database is one of the major tasks for most web
applications. The goal of batch-loader is to improve the performance of
database queries with two techniques: batching and caching.</p>
<div class="section" id="batching">
<h2>Batching<a class="headerlink" href="#batching" title="永久链接至标题">¶</a></h2>
<p>Batching is batch-loader’s primary feature. The reason for batching is
to merge multiple similar database queries into one single query when
possible. For example:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
  <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">),</span>
  <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span> <span class="p">),</span>
  <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">),</span>
  <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>is slower than</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>The latter sends only one query to database and retrieves the same 5
records as the former does, and therefore is much more efficient.</p>
<p>Batch-loader is a tool to help you batch database calls in such a way.
First, create a batch-loader by providing a batch loading function which
accepts an array of keys and an optional context. It returns a Promise
which resolves to an array of values.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">usersLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">((</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">keys</span> <span class="p">}</span> <span class="p">}</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">records</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">recordsByKey</span> <span class="o">=</span> <span class="cm">/* recordsByKey[i] is the value for key[i] */</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">recordsByKey</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">context</span><span class="o">:</span> <span class="p">{}</span> <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>You can then call the batch-loader with individual keys. It will
coalesce all requests made within the current event loop into a single
call to the batch-loader function, and return the results to each call.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">usersLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;key 1&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">));</span>
<span class="nx">usersLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;key 2&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">));</span>
<span class="nx">usersLoader</span><span class="p">.</span><span class="nx">loadMany</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">users</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">users</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">users</span><span class="p">));</span>
</pre></div>
</div>
<p>The above will result in one database service call,
i.e. <code class="docutils literal notranslate"><span class="pre">users.find({</span> <span class="pre">query:</span> <span class="pre">{</span> <span class="pre">id:</span> <span class="pre">{</span> <span class="pre">$in:</span> <span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4]</span> <span class="pre">}</span> <span class="pre">}</span> <span class="pre">})</span></code>, instead
of 6.</p>
<p class="tip"><p><em>“[W]ill coalesce all requests made within the current event loop into a
single call”</em> sounds ominous. Just don’t worry about it. Make
<code class="docutils literal notranslate"><span class="pre">usersLoader.load</span></code> and <code class="docutils literal notranslate"><span class="pre">usersLoader.loadMany</span></code> calls the same way you
would <code class="docutils literal notranslate"><span class="pre">users.get</span></code> and <code class="docutils literal notranslate"><span class="pre">users.find</span></code>. Everything will work as expected
while, behind the scenes, batch-loader is making the fewest database
calls logically possible.</p>
</p><div class="section" id="batch-function">
<h3>Batch Function<a class="headerlink" href="#batch-function" title="永久链接至标题">¶</a></h3>
<p>The batch loading function accepts an array of keys and an optional
context. It returns a Promise which resolves to an array of values. Each
index in the returned array of values must correspond to the same index
in the array of keys.</p>
<p>For example, if the <code class="docutils literal notranslate"><span class="pre">usersLoader</span></code> from above is called with
<code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4,</span> <span class="pre">99]</span></code>, we would execute
<code class="docutils literal notranslate"><span class="pre">users.find({</span> <span class="pre">query:</span> <span class="pre">{</span> <span class="pre">id:</span> <span class="pre">{</span> <span class="pre">$in:</span> <span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4,</span> <span class="pre">99]</span> <span class="pre">}</span> <span class="pre">}</span> <span class="pre">})</span></code>. The
Feathers service could return the results:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">}</span> <span class="p">]</span>
</pre></div>
</div>
<p>Please not that the order of the results will usually differ from the
order of the keys and here, in addition, there is no <code class="docutils literal notranslate"><span class="pre">users</span></code> with an
<code class="docutils literal notranslate"><span class="pre">id</span></code> of <code class="docutils literal notranslate"><span class="pre">99</span></code>.</p>
<p>The batch function has to to reorganize the above results and return:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">},</span>
  <span class="kc">null</span> <span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">null</span></code> indicating there is no record for <code class="docutils literal notranslate"><span class="pre">user.id</span> <span class="pre">===</span> <span class="pre">99</span></code>.</p>
</div>
<div class="section" id="convenience-methods">
<h3>Convenience Methods<a class="headerlink" href="#convenience-methods" title="永久链接至标题">¶</a></h3>
<p>Batch-loader provides two convenience functions that will perform this
reorganization for you.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getResultsByKey</span><span class="p">,</span> <span class="nx">getUniqueKeys</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">BatchLoader</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">usersLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">keys</span> <span class="p">=&gt;</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">records</span> <span class="p">=&gt;</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">records</span><span class="p">,</span> <span class="nx">user</span> <span class="p">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
<span class="p">);</span>
</pre></div>
</div>
<p><strong>getUniqueKeys</strong> eliminates any duplicate elements in the keys.</p>
<blockquote>
<div><p>The array of keys may contain duplicates when the batch-loader’s
memoization cache is disabled.</p>
</div></blockquote>
<p><strong>getResultsByKey</strong> reorganizes the records from the service call into
the result expected from the batch function. The <code class="docutils literal notranslate"><span class="pre">''</span></code> parameter
indicates each key expects a single record or <code class="docutils literal notranslate"><span class="pre">null</span></code>. Other options
are <code class="docutils literal notranslate"><span class="pre">'!'</span></code> when each key requires a single record, and <code class="docutils literal notranslate"><span class="pre">'[]'</span></code> when
each key requires an array of 0, 1 or more records.</p>
</div>
</div>
<div class="section" id="caching">
<h2>Caching<a class="headerlink" href="#caching" title="永久链接至标题">¶</a></h2>
<p>Each batch-loader instance contains a unique memoized cache. Once
<code class="docutils literal notranslate"><span class="pre">load</span></code> or <code class="docutils literal notranslate"><span class="pre">loadMany</span></code> is called, the resulting value is cached. This
eliminates redundant database requests, relieving pressure on your
database. It also creates fewer objects which may relieve memory
pressure on your application.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
  <span class="nx">userLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
  <span class="nx">userLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">users</span> <span class="p">=&gt;</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">users</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</pre></div>
</div>
<p class="tip"><p>The same object is returned for each of multiple hits on the cache. You
should not mutate that object directly as the mutation would be
reflected in every reference to the object. Rather you should deep-copy
before mutating the copy.</p>
</p><div class="section" id="caching-per-request">
<h3>Caching Per Request<a class="headerlink" href="#caching-per-request" title="永久链接至标题">¶</a></h3>
<p>It may be dangerous to use one cache across many users, and it is
encouraged to create a new batch-loader per request. Typically
batch-loader instances are created when a request begins and are
released once the request ends.</p>
<p>Since the cache exists for a limited time only, the cache contents
should not normally grow large enough to cause memory pressure on the
application.</p>
</div>
<div class="section" id="persistent-caches">
<h3>Persistent Caches<a class="headerlink" href="#persistent-caches" title="永久链接至标题">¶</a></h3>
<p>A batch-loader can be shared between requests and between users if care
is taken. Use caution when used in long-lived applications or those
which serve many users with different access permissions.</p>
<p>The main advantage is having the cache already primed at the start of
each request, which could result in fewer initial database requests.</p>
<div class="section" id="memory-pressure">
<h4>Memory pressure<a class="headerlink" href="#memory-pressure" title="永久链接至标题">¶</a></h4>
<p>There are two concerns though. First the cache could keep filling up
with records causing memory pressure. This can be handled with a custom
cache.</p>
<p><strong>&#64;feathers-plus/cache</strong> is a least-recently-used (LRU) cache which you
can inject when initializing the batch-loader. You can specify the
maximum number of records to be kept in the cache, and it will retain
the least recently used records.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/cache&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">usersLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span>
  <span class="nx">keys</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">cacheMap</span><span class="o">:</span> <span class="nx">cache</span><span class="p">({</span> <span class="nx">max</span><span class="o">:</span> <span class="mi">100</span> <span class="p">})</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="mutation">
<h4>Mutation<a class="headerlink" href="#mutation" title="永久链接至标题">¶</a></h4>
<p>The other concern is a record mutating. You can create a hook which
clears a record from its BatchLoaders’ caches when it mutates.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">usersLoader</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">&#64;feathers-plus/cache/lib/hooks</span></code> contains hooks which clear the
keys of mutated records.</p>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="explore-performance-gains">
<h2>Explore Performance Gains<a class="headerlink" href="#explore-performance-gains" title="永久链接至标题">¶</a></h2>
<div class="section" id="our-sample-data">
<h3>Our Sample Data<a class="headerlink" href="#our-sample-data" title="永久链接至标题">¶</a></h3>
<p>We will be using Feathers database services containing the following
data:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// app.service(&#39;posts&#39;)</span>
<span class="kr">const</span> <span class="nx">postsStore</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Marshall post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span><span class="mi">101</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Barbara post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">103</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Aubree post&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">104</span> <span class="p">}</span>
<span class="p">];</span>

<span class="c1">// app.service(&#39;comments&#39;)</span>
<span class="kr">const</span> <span class="nx">commentsStore</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 11&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 12&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 13&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Marshall post John comment 14&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Marshall post John comment 15&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Barbara post John comment 16&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Aubree post Marshall comment 17&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">}</span>
<span class="p">];</span>

<span class="c1">// app.service(&#39;users&#39;)</span>
<span class="kr">const</span> <span class="nx">usersStore</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span>
<span class="p">];</span>
</pre></div>
</div>
<p>We want to see how using batch-loader affects the number of database
calls, and we will do that by populating the <code class="docutils literal notranslate"><span class="pre">posts</span></code> records with
related information.</p>
</div>
<div class="section" id="using-plain-javascript">
<h3>Using Plain JavaScript<a class="headerlink" href="#using-plain-javascript" title="永久链接至标题">¶</a></h3>
<p>First, let’s add the related <code class="docutils literal notranslate"><span class="pre">comments</span></code> records to each <code class="docutils literal notranslate"><span class="pre">posts</span></code>
record using regular JavaScript, and let’s do this using both Promises
and async/await.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Populate using Promises.</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">posts</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">posts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">comments</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">comments</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">post</span><span class="p">;</span>
    <span class="p">})</span>
  <span class="p">)))</span>
<span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">...</span> <span class="p">);</span>

<span class="c1">// Populate using async/await.</span>
<span class="kr">const</span> <span class="nx">postRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">postRecords</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">post</span><span class="p">.</span><span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">post</span><span class="p">;</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>Both of these make the following database service calls, and both get
the following result.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">...</span> <span class="nx">posts</span> <span class="nx">find</span>
<span class="p">...</span> <span class="nx">comments</span> <span class="nx">find</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="p">...</span> <span class="nx">comments</span> <span class="nx">find</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="p">...</span> <span class="nx">comments</span> <span class="nx">find</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
<span class="p">...</span> <span class="nx">comments</span> <span class="nx">find</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">4</span> <span class="p">}</span>

<span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">commentRecords</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 11&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 12&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 13&#39;</span><span class="p">,</span> <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span> <span class="p">}</span> <span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="using-neither-batching-nor-caching">
<h3>Using Neither Batching nor Caching<a class="headerlink" href="#using-neither-batching-nor-caching" title="永久链接至标题">¶</a></h3>
<p>The batch-loader function will be called for every <code class="docutils literal notranslate"><span class="pre">load</span></code> and
<code class="docutils literal notranslate"><span class="pre">loadMany</span></code> when batching and caching are disabled in the batch-loader.
This means it acts just like individual <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">find</span></code> method
calls. Let’s rewrite the above example using such a rudimentary
batch-loader:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getResultsByKey</span><span class="p">,</span> <span class="nx">getUniqueKeys</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">BatchLoader</span><span class="p">;</span>

<span class="c1">// Populate using Promises.</span>
<span class="kr">const</span> <span class="nx">commentsLoaderPromises</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span>
  <span class="nx">keys</span> <span class="p">=&gt;</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">=&gt;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="s1">&#39;[]&#39;</span><span class="p">)),</span>
  <span class="p">{</span> <span class="nx">batch</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">cache</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
<span class="p">);</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">postRecords</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">postRecords</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">post</span> <span class="p">=&gt;</span> <span class="nx">commentsLoaderPromises</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">comments</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">post</span><span class="p">.</span><span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">comments</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">post</span><span class="p">;</span>
    <span class="p">})</span>
  <span class="p">)))</span>
<span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">});</span>

<span class="c1">// Populate using async/await.</span>
<span class="kr">const</span> <span class="nx">commentsLoaderAwait</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">async</span> <span class="nx">keys</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">postRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">postRecords</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">=&gt;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="s1">&#39;[]&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">batch</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">cache</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">postRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">postRecords</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">post</span><span class="p">.</span><span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">commentsLoaderAwait</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">post</span><span class="p">;</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>Both of these make the same database service calls as did the <a class="reference external" href="#Using-Plain-JavaScript">plain
JavaScript example</a>, because batching and
caching were both disabled.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>... posts find
... comments find { postId: { &#39;$in&#39;: [ 1 ] } }
... comments find { postId: { &#39;$in&#39;: [ 2 ] } }
... comments find { postId: { &#39;$in&#39;: [ 3 ] } }
... comments find { postId: { &#39;$in&#39;: [ 4 ] } }
</pre></div>
</div>
<blockquote>
<div><p>A batch-loader with neither batching nor caching makes the same
database calls as does a plain Javascript implementation. This is a
convenient way to debug issues you might have with batch-loader. The
<em>“magic”</em> disappears when you disable batching and caching, which
makes it simpler to understand what is happening.</p>
</div></blockquote>
</div>
<div class="section" id="using-batching-and-caching">
<h3>Using Batching and Caching<a class="headerlink" href="#using-batching-and-caching" title="永久链接至标题">¶</a></h3>
<p>Batching and caching are enabled when we remove the 2
<code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">batch:</span> <span class="pre">false,</span> <span class="pre">cache:</span> <span class="pre">false</span> <span class="pre">}</span></code> in the above example. A very
different performance profile is now produced:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>... posts find
... comments find { postId: { &#39;$in&#39;: [ 1, 2, 3, 4 ] } }
</pre></div>
</div>
<p>Only 1 service call was made for the <code class="docutils literal notranslate"><span class="pre">comments</span></code> records, instead of
the previous 4.</p>
</div>
<div class="section" id="a-realistic-example">
<h3>A Realistic Example<a class="headerlink" href="#a-realistic-example" title="永久链接至标题">¶</a></h3>
<p>The more service calls made, the better batch-loader performs. The above
example populated the <code class="docutils literal notranslate"><span class="pre">posts</span></code> records with just the <code class="docutils literal notranslate"><span class="pre">comments</span></code>
records. Let’s see the effect batch-loader has when we fully populate
the <code class="docutils literal notranslate"><span class="pre">posts</span></code> records.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">parallel</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;asyncro&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">BatchLoader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathers-plus/batch-loader&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">getResultsByKey</span><span class="p">,</span> <span class="nx">getUniqueKeys</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">BatchLoader</span><span class="p">;</span>

<span class="nx">tester</span><span class="p">({</span> <span class="nx">batch</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">cache</span><span class="o">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">)</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">tester</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">commentsLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">async</span> <span class="nx">keys</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">postId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">comment</span> <span class="p">=&gt;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="s1">&#39;[]&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">options</span>
  <span class="p">);</span>

  <span class="kr">const</span> <span class="nx">usersLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BatchLoader</span><span class="p">(</span><span class="nx">async</span> <span class="nx">keys</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$in</span><span class="o">:</span> <span class="nx">getUniqueKeys</span><span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">getResultsByKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">user</span> <span class="p">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">options</span>
  <span class="p">);</span>

  <span class="kr">const</span> <span class="nx">postRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>

  <span class="nx">await</span> <span class="nx">map</span><span class="p">(</span><span class="nx">postRecords</span><span class="p">,</span> <span class="nx">async</span> <span class="nx">post</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">parallel</span><span class="p">([</span>
      <span class="c1">// Join one users record to posts, for post.userId === users.id</span>
      <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">post</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">usersLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="c1">// Join 0, 1 or many comments records to posts, where comments.postId === posts.id</span>
      <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">commentsLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">post</span><span class="p">.</span><span class="nx">commentRecords</span> <span class="o">=</span> <span class="nx">commentRecords</span><span class="p">;</span>

        <span class="c1">// Join one users record to comments, for comments.userId === users.id</span>
        <span class="nx">await</span> <span class="nx">map</span><span class="p">(</span><span class="nx">commentRecords</span><span class="p">,</span> <span class="nx">async</span> <span class="nx">comment</span> <span class="p">=&gt;</span> <span class="p">{</span>
          <span class="nx">comment</span><span class="p">.</span><span class="nx">userRecord</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">usersLoader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">},</span>
      <span class="c1">// Join 0, 1 or many users record to posts, where posts.starIds === users.id</span>
      <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">post</span><span class="p">.</span><span class="nx">starUserRecords</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">usersLoader</span><span class="p">.</span><span class="nx">loadMany</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">starIds</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">]);</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">postRecords</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>Notice <code class="docutils literal notranslate"><span class="pre">usersLoader</span></code> is being called within 3 quite different
joins. These joins will share their batching and cache, noticeably
improving overall performance.</p>
</div></blockquote>
<p>This example has batching and caching disabled. These 22 service calls
are made when it is run. They are the same calls which a plain
JavaScript implementation would have made:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>... posts find
... users find { id: { &#39;$in&#39;: [ 101 ] } }
... comments find { postId: { &#39;$in&#39;: [ 1 ] } }
... users find { id: { &#39;$in&#39;: [ 102 ] } }
... users find { id: { &#39;$in&#39;: [ 103 ] } }
... users find { id: { &#39;$in&#39;: [ 104 ] } }
... users find { id: { &#39;$in&#39;: [ 102 ] } }
... comments find { postId: { &#39;$in&#39;: [ 2 ] } }
... users find { id: { &#39;$in&#39;: [ 101 ] } }
... users find { id: { &#39;$in&#39;: [ 103 ] } }
... users find { id: { &#39;$in&#39;: [ 104 ] } }
... users find { id: { &#39;$in&#39;: [ 103 ] } }
... comments find { postId: { &#39;$in&#39;: [ 3 ] } }
... users find { id: { &#39;$in&#39;: [ 104 ] } }
... comments find { postId: { &#39;$in&#39;: [ 4 ] } }
... users find { id: { &#39;$in&#39;: [ 102 ] } }
... users find { id: { &#39;$in&#39;: [ 102 ] } }
... users find { id: { &#39;$in&#39;: [ 102 ] } }
... users find { id: { &#39;$in&#39;: [ 101 ] } }
... users find { id: { &#39;$in&#39;: [ 101 ] } }
... users find { id: { &#39;$in&#39;: [ 101 ] } }
... users find { id: { &#39;$in&#39;: [ 102 ] } }
</pre></div>
</div>
<p>Now let’s enable batching and caching by changing
<code class="docutils literal notranslate"><span class="pre">tester({</span> <span class="pre">batch:</span> <span class="pre">false,</span> <span class="pre">cache:</span> <span class="pre">false</span> <span class="pre">})</span></code> to <code class="docutils literal notranslate"><span class="pre">tester()</span></code>. Only these
<strong>three</strong> service calls are now made to obtain the same results:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>... posts find
... users find { id: { &#39;$in&#39;: [ 101, 102, 103, 104 ] } }
... comments find { postId: { &#39;$in&#39;: [ 1, 2, 3, 4 ] } }
</pre></div>
</div>
<blockquote>
<div><p>The 2 BatchLoaders reduced the number of services calls from 22 for a
plain implementation, to just 3!</p>
</div></blockquote>
<p>The final populated result is:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;John post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span>
    <span class="nx">starUserRecords</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span> <span class="p">],</span>
    <span class="nx">commentRecords</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 11&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 12&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;John post Marshall comment 13&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Marshall post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
    <span class="nx">starIds</span><span class="o">:</span> <span class="p">[</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span> <span class="p">],</span>
    <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">},</span>
    <span class="nx">starUserRecords</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">}</span> <span class="p">],</span>
    <span class="nx">commentRecords</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Marshall post John comment 14&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">}</span> <span class="p">},</span>
       <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Marshall post John comment 15&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Barbara post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span>
    <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Barbara&#39;</span> <span class="p">},</span>
    <span class="nx">commentRecords</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Barbara post John comment 16&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Aubree post&#39;</span><span class="p">,</span>
    <span class="nx">userId</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span>
    <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">104</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Aubree&#39;</span> <span class="p">},</span>
    <span class="nx">commentRecords</span><span class="o">:</span>
     <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span>
         <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Aubree post Marshall comment 17&#39;</span><span class="p">,</span>
         <span class="nx">postId</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
         <span class="nx">userId</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span>
         <span class="nx">userRecord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Marshall&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/facebook/dataloader">facebook/dataloader</a> from
which batch-loader is derived.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="common-patterns.html" class="btn btn-neutral float-right" title="batch-loader common patterns" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="batch-loader Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>